<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BQGMFEFQJ1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BQGMFEFQJ1');
    </script>
    
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>PredictionMarketPulse - Prediction Market Partnership Tracker & Regulatory Guide</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Track prediction market partnerships, understand regulatory structures (CFTC, NFA, FCM, DCM, DCO), and try our interactive trading simulation. Follow the evolving prediction markets ecosystem. Updated regularly with 56+ partnerships including Kalshi, Polymarket, Coinbase, and more."/>
    <meta name="keywords" content="prediction markets, Kalshi, Polymarket, event contracts, CFTC regulation, futures commission merchant, FCM, DCM, DCO, sports betting, regulated markets, prediction market partnerships"/>
    <meta name="author" content="Josh Pearl, Grant Hartman"/>
    <meta name="robots" content="index, follow"/>
    <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
    <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
    <link rel="canonical" href="https://predictionmarketpulse.com"/>
    
    <!-- Citation and Attribution for AI Engines -->
    <meta name="citation_title" content="PredictionMarketPulse - Prediction Market Partnership Tracker"/>
    <meta name="citation_publication_date" content="2024-12-01"/>
    <meta name="citation_online_date" content="2025-01-05"/>
    <meta name="citation_author" content="Josh Pearl"/>
    <meta name="citation_author" content="Grant Hartman"/>
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="manifest" href="/site.webmanifest"/>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://predictionmarketpulse.com"/>
    <meta property="og:title" content="PredictionMarketPulse - Prediction Market Partnership Tracker"/>
    <meta property="og:description" content="Track prediction market partnerships and understand regulatory structures. Updated regularly with 56+ partnerships including Kalshi, Polymarket, Coinbase, and more."/>
    <meta property="og:site_name" content="PredictionMarketPulse"/>
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:url" content="https://predictionmarketpulse.com"/>
    <meta name="twitter:title" content="PredictionMarketPulse - Prediction Market Partnership Tracker"/>
    <meta name="twitter:description" content="Track prediction market partnerships and understand regulatory structures. Updated regularly with 56+ partnerships."/>
    
    <!-- Structured Data (JSON-LD) for Generative Engine Optimization -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "PredictionMarketPulse",
      "alternateName": "Prediction Market Pulse",
      "url": "https://predictionmarketpulse.com",
      "description": "Independent tracker and guide for prediction market partnerships and regulatory structures. Comprehensive database of 56+ partnerships in the CFTC-regulated prediction markets ecosystem including Kalshi, Polymarket, Coinbase, DraftKings, FanDuel, and more.",
      "about": {
        "@type": "Thing",
        "name": "Prediction Markets",
        "description": "CFTC-regulated event contracts and prediction markets in the United States, including partnerships, regulatory entities (FCM, DCM, DCO, IB, NFA), and market structure"
      },
      "mainEntity": {
        "@type": "Dataset",
        "name": "Prediction Market Partnerships Database",
        "description": "Comprehensive database tracking 56+ partnerships in the US prediction markets industry, including operational relationships, regulatory designations, and market structure details",
        "temporalCoverage": "2024/..",
        "spatialCoverage": "United States",
        "variableMeasured": ["Partnership Type", "Regulatory Structure", "FCM", "DCM", "DCO", "IB"],
        "includedInDataCatalog": {
          "@type": "DataCatalog",
          "name": "Prediction Markets Industry Data"
        }
      },
      "author": [
        {
          "@type": "Person",
          "name": "Josh Pearl",
          "description": "Over a decade of experience in regulated gambling spanning online horse racing, sports wagering, online casino, and paid fantasy sports. Previously led new-state launch efforts at Penn Interactive.",
          "jobTitle": "Regulated Gambling Consultant",
          "url": "https://www.linkedin.com/in/joshua-pearl-14b73627/",
          "knowsAbout": ["Prediction Markets", "Sports Betting Regulation", "CFTC Compliance", "Gaming Regulation"]
        },
        {
          "@type": "Person",
          "name": "Grant Hartman",
          "jobTitle": "Director of Client Engagement",
          "affiliation": {
            "@type": "Organization",
            "name": "Chariot Solutions",
            "url": "https://chariotsolutions.com"
          },
          "url": "https://www.linkedin.com/in/ghartman/",
          "knowsAbout": ["Regulated Technology", "Prediction Markets", "Sports Betting Software", "Gaming Technology"]
        }
      ],
      "keywords": "prediction markets, Kalshi, Polymarket, CFTC, event contracts, futures commission merchant, FCM, designated contract market, DCM, derivatives clearing organization, DCO, introducing broker, IB, National Futures Association, NFA, sports betting, regulated markets, Coinbase, DraftKings, FanDuel, Robinhood, ICE, CME",
      "inLanguage": "en-US",
      "datePublished": "2024-12-01",
      "dateModified": "2025-01-05",
      "publisher": {
        "@type": "Organization",
        "name": "PredictionMarketPulse"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://predictionmarketpulse.com/?search={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    
    <!-- Additional FAQPage Schema for Common Questions -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is a Futures Commission Merchant (FCM)?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "A Futures Commission Merchant (FCM) is an entity registered with the CFTC that accepts orders to buy or sell futures contracts and accepts money or other assets from customers to support such orders. In prediction markets, FCMs facilitate customer access to event contracts."
          }
        },
        {
          "@type": "Question",
          "name": "What is a Designated Contract Market (DCM)?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "A Designated Contract Market (DCM) is a CFTC-regulated exchange where futures contracts and event contracts can be traded. Examples include Kalshi, Crypto.com (CDNA), and ForecastEx."
          }
        },
        {
          "@type": "Question",
          "name": "Who regulates prediction markets in the United States?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The Commodity Futures Trading Commission (CFTC) regulates prediction markets in the United States. Market participants must register with the National Futures Association (NFA) and comply with CFTC regulations."
          }
        },
        {
          "@type": "Question",
          "name": "What companies offer prediction markets?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Major companies offering or powering prediction markets include Kalshi, Polymarket, Coinbase, DraftKings, FanDuel, Robinhood, Interactive Brokers, Crypto.com (CDNA), and many others. PredictionMarketPulse tracks 56+ partnerships in this space."
          }
        }
      ]
    }
    </script>
    
    <script>
        // Initialize dark mode before page renders to prevent flash
        (function() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true' || (!darkMode && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: "#4338ca",
                        "primary-hover": "#3730a3",
                    },
                },
            },
        };
    </script>
    <style>
        /* ========================================
           EXPERT DARK MODE IMPLEMENTATION
           Using CSS Custom Properties (Design Tokens)
           ======================================== */
        
        :root {
            /* Light Mode Color Tokens */
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8fafc;
            --color-bg-tertiary: #f1f5f9;
            --color-text-primary: #0f172a;
            --color-text-secondary: #475569;
            --color-text-tertiary: #64748b;
            --color-border-light: #e2e8f0;
            --color-border-medium: #cbd5e1;
            --color-surface: #ffffff;
            --color-surface-hover: #f8fafc;
            
            /* Brand Colors */
            --color-primary: #4338ca;
            --color-primary-light: #6366f1;
            --color-primary-dark: #3730a3;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .dark {
            /* Dark Mode Color Tokens - Optimized for readability and eye comfort */
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: #334155;
            --color-text-primary: #f8fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-border-light: #334155;
            --color-border-medium: #475569;
            --color-surface: #1e293b;
            --color-surface-hover: #334155;
            
            /* Adjusted brand colors for dark mode */
            --color-primary: #6366f1;
            --color-primary-light: #818cf8;
            --color-primary-dark: #4f46e5;
            
            /* Enhanced shadows for dark mode */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Base Styles with smooth transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        body {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            min-height: 100vh;
        }

        /* Subtle gradient overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(168, 85, 247, 0.03) 100%);
        }

        .dark body::before {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(168, 85, 247, 0.08) 100%);
        }
        
        .material-icons-outlined {
            font-size: 24px;
            line-height: 1;
        }
        
        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .badge-Data { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .badge-Operational { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .badge-Investment { 
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }
        .badge-Other { 
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
        }
        .badge-Government { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        .badge-Capital {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        .badge-Acquisition {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
        }
        .badge-Marketing {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
        }
        
        /* Mobile badge adjustments */
        @media (max-width: 640px) {
            .badge-Data,
            .badge-Operational,
            .badge-Capital,
            .badge-Government,
            .badge-Investment,
            .badge-Other {
                font-size: 0.65rem;
                line-height: 1.2;
                max-width: 100%;
            }
        }

        .partnership-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideIn 0.4s ease-out;
            box-shadow: var(--shadow-md);
        }

        .partnership-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--color-primary);
        }

        .regulatory-box {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-light);
            position: relative;
            overflow: hidden;
        }

        .regulatory-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light), var(--color-primary));
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .info-icon {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            color: white;
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
            font-size: 16px;
        }

        .announcement-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            color: var(--color-primary);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .announcement-link:hover {
            color: var(--color-primary-light);
            gap: 0.5rem;
        }

        .announcement-link .material-icons-outlined {
            font-size: 16px;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark .hero-gradient {
            background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .section-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border-medium);
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .section-card:hover::before {
            transform: scaleX(1);
        }

        .section-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .nav-btn {
            position: relative;
            overflow: hidden;
            color: #64748b;
        }

        .dark .nav-btn {
            color: #cbd5e1;
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--color-primary);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-btn.nav-active {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .dark .nav-btn.nav-active {
            background-color: rgba(99, 102, 241, 0.15);
        }

        .nav-btn.text-primary::after {
            width: 80%;
        }

        .nav-btn-mobile {
            color: #64748b;
        }

        .dark .nav-btn-mobile {
            color: #cbd5e1;
        }

        .nav-btn-mobile.nav-active {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .dark .nav-btn-mobile.nav-active {
            background-color: rgba(99, 102, 241, 0.15);
        }

        .nav-btn-mobile.text-primary {
            background-color: #eef2ff;
            color: var(--color-primary);
        }

        .dark .nav-btn-mobile.text-primary {
            background-color: rgba(67, 56, 202, 0.2);
            color: #a5b4fc;
        }

        .icon-badge {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-primary) 100%);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .dark .icon-badge {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .reg-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .dark .reg-label {
            color: #94a3b8;
        }

        /* ========================================
           NETWORK GRAPH STYLES
           ======================================== */

        /* Container — gradient bg, shimmer bar, orbs */
        .network-container {
            position: relative;
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border: 1px solid var(--color-border-light);
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }
        .dark .network-container {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: rgba(99, 102, 241, 0.15);
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.05), var(--shadow-xl);
        }
        .network-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            z-index: 5;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }
        .network-orb-1 {
            position: absolute; top: -80px; right: -80px;
            width: 320px; height: 320px;
            background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%);
            border-radius: 50%; pointer-events: none; z-index: 0;
        }
        .dark .network-orb-1 { background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, transparent 70%); }
        .network-orb-2 {
            position: absolute; bottom: -60px; left: -60px;
            width: 280px; height: 280px;
            background: radial-gradient(circle, rgba(168,85,247,0.06) 0%, transparent 70%);
            border-radius: 50%; pointer-events: none; z-index: 0;
        }
        .dark .network-orb-2 { background: radial-gradient(circle, rgba(168,85,247,0.12) 0%, transparent 70%); }

        /* SVG canvas */
        .network-svg {
            width: 100%;
            height: 600px;
            cursor: grab;
            position: relative;
            z-index: 1;
        }
        .network-svg:active { cursor: grabbing; }

        /* Node shapes */
        .network-svg .node-shape {
            stroke-width: 2;
            stroke-opacity: 0.7;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.15s ease;
        }
        .network-svg .node-group:hover .node-shape {
            transform: scale(1.12);
        }

        /* Labels — halo for readability */
        .network-svg .node-label {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 10px;
            font-weight: 600;
            fill: var(--color-text-primary);
            pointer-events: none;
            text-anchor: middle;
            paint-order: stroke;
            stroke: var(--color-surface);
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .dark .network-svg .node-label { stroke: #0f172a; }
        .network-svg .node-label.label-hub {
            opacity: 1;
            font-weight: 700;
            letter-spacing: 0.01em;
        }
        .network-svg .node-label.label-hidden {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .network-svg .node-group:hover .node-label.label-hidden,
        .network-svg .highlighted .node-label.label-hidden {
            opacity: 1;
            transition: opacity 0.15s ease;
        }

        /* Minor nodes */
        .network-svg .node-minor .node-shape { opacity: 0.5; }
        .network-svg .node-group:hover .node-minor .node-shape,
        .network-svg .highlighted .node-minor .node-shape { opacity: 1; }

        /* Edges */
        .network-svg .edge-line {
            stroke-linecap: round;
            transition: stroke-opacity 0.25s ease, stroke-width 0.25s ease;
            cursor: pointer;
        }
        .network-svg .edge-line.edge-minor { stroke-opacity: 0.15; }
        .network-svg .edge-line.edge-minor.highlighted { stroke-opacity: 0.65; }

        /* Dim state */
        .network-svg .dimmed .node-shape { opacity: 0.08; transition: opacity 0.3s ease; }
        .network-svg .dimmed .node-label { opacity: 0.06; transition: opacity 0.3s ease; }
        .network-svg .dimmed .edge-line,
        .network-svg .edge-line.dimmed { stroke-opacity: 0.03; transition: stroke-opacity 0.3s ease; }

        /* Highlighted state */
        .network-svg .highlighted .node-shape { opacity: 1; transition: opacity 0.15s ease; }
        .network-svg .highlighted .node-label { opacity: 1; font-weight: 700; transition: opacity 0.15s ease; }
        .network-svg .highlighted .edge-line,
        .network-svg .edge-line.highlighted { stroke-opacity: 0.9; transition: stroke-opacity 0.15s ease; }

        /* Hub pulse */
        @keyframes hubPulse {
            0%, 100% { opacity: 0.35; }
            50% { opacity: 0.1; }
        }
        .network-svg .hub-halo { animation: hubPulse 3s ease-in-out infinite; }
        .dark .network-svg .hub-halo { stroke-opacity: 0.5; }
        .network-svg .edge-particle { pointer-events: none; }
        .network-svg .connection-badge { pointer-events: none; }

        /* Tooltip — glass morphism */
        .graph-tooltip {
            position: absolute;
            pointer-events: none;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 1rem;
            padding: 0.875rem 1.125rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);
            backdrop-filter: blur(16px);
            font-size: 0.8rem;
            z-index: 25;
            max-width: 280px;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        .graph-tooltip.visible { opacity: 1; transform: translateY(0); }
        .dark .graph-tooltip {
            background: rgba(30,41,59,0.95);
            border-color: rgba(99,102,241,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 1px rgba(99,102,241,0.3);
        }
        .graph-tooltip .tt-name {
            font-weight: 700; font-size: 0.875rem;
            color: var(--color-text-primary);
            margin-bottom: 0.375rem;
            display: flex; align-items: center; gap: 0.375rem;
        }
        .graph-tooltip .tt-role {
            font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.06em; font-weight: 600;
            margin-bottom: 0.5rem; padding: 0.15rem 0.5rem;
            border-radius: 0.25rem; display: inline-block;
        }
        .graph-tooltip .tt-count {
            font-size: 0.75rem; color: var(--color-text-secondary);
            display: flex; align-items: center; gap: 0.25rem;
        }

        /* Detail panel */
        .graph-detail-panel {
            position: absolute; top: 0; right: 0;
            width: 340px; height: 100%;
            background: var(--color-surface);
            border-left: 1px solid var(--color-border-light);
            box-shadow: -8px 0 32px rgba(0,0,0,0.08);
            z-index: 15; overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 0;
        }
        .dark .graph-detail-panel {
            background: rgba(15,23,42,0.97);
            border-left-color: rgba(99,102,241,0.12);
            box-shadow: -8px 0 32px rgba(0,0,0,0.4);
        }
        .graph-detail-panel.open { transform: translateX(0); }
        .graph-detail-panel .dp-close {
            position: absolute; top: 1rem; right: 1rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-light);
            cursor: pointer; color: var(--color-text-tertiary);
            font-size: 1.125rem; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 0.5rem; transition: all 0.2s; z-index: 2;
        }
        .graph-detail-panel .dp-close:hover {
            background: var(--color-primary); color: white; border-color: var(--color-primary);
        }
        .graph-detail-panel .dp-name {
            font-size: 1.125rem; font-weight: 700;
            color: var(--color-text-primary); margin-bottom: 0.25rem;
        }
        .graph-detail-panel .dp-role {
            font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; font-weight: 600;
        }
        .graph-detail-panel .dp-partnership {
            padding: 0.75rem 0.875rem; border-radius: 0.625rem;
            background: var(--color-bg-tertiary);
            margin-bottom: 0.5rem; font-size: 0.8rem;
            border-left: 3px solid var(--color-primary);
            transition: background 0.2s ease;
        }
        .graph-detail-panel .dp-partnership:hover { background: var(--color-surface-hover); }
        .graph-detail-panel .dp-partnership .dp-p-name {
            font-weight: 600; color: var(--color-text-primary); margin-bottom: 0.25rem;
        }
        .graph-detail-panel .dp-partnership .dp-p-type {
            font-size: 0.7rem; color: var(--color-text-tertiary);
        }

        /* Controls — glass morphism */
        .network-controls {
            display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;
            margin-bottom: 0.75rem; padding: 0.75rem 1rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 1rem; backdrop-filter: blur(12px);
            box-shadow: var(--shadow-sm);
        }
        .dark .network-controls {
            background: rgba(30,41,59,0.85);
            border-color: rgba(99,102,241,0.1);
        }
        .network-controls select,
        .network-controls input {
            padding: 0.4rem 0.85rem;
            border: 1.5px solid var(--color-border-light);
            border-radius: 0.5rem;
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.8rem; font-weight: 500;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .network-controls select:focus,
        .network-controls input:focus {
            outline: none;
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
        }
        .network-controls .btn-reset {
            padding: 0.4rem 0.75rem;
            border: 1.5px solid var(--color-border-light);
            border-radius: 0.5rem;
            background: var(--color-bg-secondary);
            color: var(--color-text-secondary);
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 0.3rem;
            transition: all 0.2s ease;
        }
        .network-controls .btn-reset:hover {
            border-color: var(--color-primary); color: var(--color-primary);
            background: rgba(99,102,241,0.05);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.08);
        }

        /* Guided question chips */
        .graph-questions {
            display: flex; flex-wrap: wrap; gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 0.75rem;
            backdrop-filter: blur(12px);
        }
        .dark .graph-questions {
            background: rgba(30,41,59,0.85);
            border-color: rgba(99,102,241,0.15);
        }
        .graph-chip {
            padding: 0.3rem 0.7rem;
            border: 1.5px solid var(--color-border-light);
            border-radius: 999px;
            background: var(--color-bg-secondary);
            color: var(--color-text-secondary);
            font-size: 0.75rem; font-weight: 600;
            cursor: pointer; white-space: nowrap;
            transition: all 0.2s ease;
        }
        .graph-chip:hover {
            border-color: var(--color-primary); color: var(--color-primary);
            background: rgba(99,102,241,0.05);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.08);
        }
        .graph-chip.active {
            background: var(--color-primary); color: #fff;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.18);
        }

        /* Legend — floating pill inside container */
        .network-legend {
            position: absolute; bottom: 1rem; left: 1rem; z-index: 10;
            display: flex; gap: 0.75rem; flex-wrap: wrap;
            padding: 0.5rem 0.75rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 0.75rem; backdrop-filter: blur(12px);
            box-shadow: var(--shadow-md);
            font-size: 0.7rem; color: var(--color-text-secondary);
            max-width: calc(100% - 2rem);
            max-height: calc(100% - 2rem); overflow-y: auto;
        }
        .dark .network-legend {
            background: rgba(30,41,59,0.9);
            border-color: rgba(99,102,241,0.1);
        }
        .network-legend .legend-item {
            display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;
            cursor: pointer; user-select: none; transition: opacity 0.2s ease;
        }
        .network-legend .legend-item.legend-inactive {
            opacity: 0.35; text-decoration: line-through;
        }
        .network-legend .legend-item:hover { opacity: 0.75; }
        .network-legend .legend-item.legend-inactive:hover { opacity: 0.5; }
        .network-legend .legend-divider {
            width: 100%; height: 0; border-top: 1px solid var(--color-border-light); margin: 0.15rem 0;
        }
        .network-legend .legend-swatch {
            width: 12px; height: 12px; border-radius: 3px;
            flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        /* Zoom controls */
        .graph-zoom-controls {
            position: absolute; top: 1rem; right: 1rem; z-index: 10;
            display: flex; flex-direction: column; gap: 0.25rem;
        }
        .graph-zoom-controls button {
            width: 32px; height: 32px; border: 1px solid var(--color-border-light);
            border-radius: 0.5rem; background: var(--color-surface);
            backdrop-filter: blur(12px); box-shadow: var(--shadow-md);
            color: var(--color-text-secondary); font-size: 1.1rem; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease; padding: 0;
        }
        .graph-zoom-controls button:hover {
            border-color: var(--color-primary); color: var(--color-primary);
            background: rgba(99,102,241,0.05); box-shadow: 0 0 0 3px rgba(99,102,241,0.08);
        }
        .dark .graph-zoom-controls button {
            background: rgba(30,41,59,0.9); border-color: rgba(99,102,241,0.1);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .network-svg { height: 450px; }
            .graph-detail-panel {
                top: auto; bottom: 0; left: 0; right: 0;
                width: 100%; height: 50%;
                border-left: none;
                border-top: 1px solid var(--color-border-light);
                border-radius: 1.5rem 1.5rem 0 0;
                transform: translateY(100%);
            }
            .graph-detail-panel.open { transform: translateY(0); }
        }
        @media (max-width: 640px) {
            .network-svg { height: 350px; }
            .network-svg .node-label { display: none; }
            .network-svg .node-label.tap-visible { display: block; }
            .network-svg .node-label.label-hub { display: block; font-size: 9px; }
            .network-svg .node-shape { stroke-width: 2.5; }
            .network-controls { gap: 0.375rem; padding: 0.5rem 0.75rem; border-radius: 0.75rem; }
            .network-controls select,
            .network-controls input { font-size: 0.75rem; padding: 0.35rem 0.6rem; }
            .network-legend { bottom: 0.5rem; left: 0.5rem; gap: 0.4rem; font-size: 0.6rem; padding: 0.35rem 0.5rem; }
            .graph-zoom-controls { top: 0.5rem; right: 0.5rem; }
            .graph-zoom-controls button { width: 28px; height: 28px; }
            .network-svg .edge-particle { display: none; }
            .network-svg .connection-badge { display: none; }
            .network-svg .hub-halo { display: none; }
            .graph-questions { gap: 0.3rem; padding: 0.4rem 0.6rem; }
            .graph-chip { font-size: 0.65rem; padding: 0.25rem 0.55rem; }
        }
    </style>
</head>
<body class="font-sans bg-slate-50 dark:bg-slate-900 dark:bg-slate-900 text-slate-700 dark:text-slate-200 transition-colors duration-200">
    
    <!-- Semantic Content for Generative Engines (Hidden) -->
    <div style="display: none;" aria-hidden="true">
        <h1>PredictionMarketPulse: Comprehensive Prediction Markets Partnership Tracker</h1>
        <p>Last Updated: January 2025 | 45+ Active Partnerships Tracked</p>
        
        <section>
            <h2>What is PredictionMarketPulse?</h2>
            <p>PredictionMarketPulse is an independent tracker documenting partnerships, regulatory structures, and market relationships in the US prediction markets ecosystem. The site explains CFTC-regulated event contracts and how companies like Kalshi, Polymarket, Coinbase, DraftKings, FanDuel, and Robinhood operate within the regulatory framework.</p>
        </section>
        
        <section>
            <h2>Key Regulatory Entities Explained</h2>
            <ul>
                <li><strong>CFTC (Commodity Futures Trading Commission):</strong> Primary federal regulator overseeing prediction markets and event contracts</li>
                <li><strong>NFA (National Futures Association):</strong> Self-regulatory organization for the futures industry</li>
                <li><strong>FCM (Futures Commission Merchant):</strong> Entity accepting orders and money to support futures/event contract trading</li>
                <li><strong>DCM (Designated Contract Market):</strong> CFTC-regulated exchange for trading contracts</li>
                <li><strong>DCO (Derivatives Clearing Organization):</strong> Entity providing clearing services for derivatives</li>
                <li><strong>IB (Introducing Broker):</strong> Entity introducing customers to FCMs or DCMs</li>
            </ul>
        </section>
        
        <section>
            <h2>Major Players in Prediction Markets (January 2025)</h2>
            <ul>
                <li><strong>Kalshi:</strong> CFTC-regulated prediction market platform, DCM and DCO, partners with Coinbase, PrizePicks, Robinhood, WeBull, Phantom, NHL, Google, CNN, CNBC, StockX</li>
                <li><strong>Polymarket:</strong> Acquired QCEX (DCM/DCO), partners with ICE, DraftKings, PrizePicks, Yahoo, UFC/TKO, X (Twitter), Chess.com</li>
                <li><strong>Coinbase:</strong> Launching prediction markets powered by Kalshi, acquiring The Clearing Company</li>
                <li><strong>DraftKings:</strong> Acquired Railbird, operates as IB, uses Polymarket for clearing</li>
                <li><strong>FanDuel:</strong> Partnership with CME, operates prediction markets through joint venture</li>
                <li><strong>Crypto.com (CDNA):</strong> DCM and DCO, partners with Underdog Fantasy, Fanatics, Trump Media, MyPrize, Hollywood.com</li>
                <li><strong>Robinhood:</strong> Acquiring MIAX Derivatives Exchange with SIG, partnering with Kalshi</li>
            </ul>
        </section>
        
        <section>
            <h2>Partnership Types</h2>
            <ul>
                <li><strong>Data/Marketing:</strong> Content partnerships, data distribution, branding (NHL, ESPN, Google, Yahoo)</li>
                <li><strong>Operational:</strong> Platform integrations, exchange access, clearing services</li>
                <li><strong>Capital/Collaboration:</strong> Strategic investments and business development (ICE/Polymarket)</li>
                <li><strong>Government Affairs:</strong> Industry coalitions and regulatory advocacy</li>
            </ul>
        </section>
        
        <section>
            <h2>Site Creators</h2>
            <p><strong>Josh Pearl:</strong> Over a decade in regulated gambling (horse racing, sports wagering, casino, fantasy sports). Former Penn Interactive executive leading new-state launches. Now consulting with regulated gambling companies.</p>
            <p><strong>Grant Hartman:</strong> Director of Client Engagement at Chariot Solutions, working with clients in gaming, sports betting, and prediction markets on complex regulated software projects.</p>
        </section>
        
        <section>
            <h2>Contact</h2>
            <p>Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="65151700010c06110c0a0b0804170e00111510091600250208040c094b060a08">[email&#160;protected]</a></p>
            <p>The site welcomes feedback, partnership suggestions, and industry updates.</p>
        </section>
        
        <meta itemprop="lastReviewed" content="2025-01-05">
        <meta itemprop="citation" content="Source: PredictionMarketPulse.com - Independent prediction markets partnership tracker">
    </div>
    
    <!-- End Semantic Content -->

    <header class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-lg border-b border-slate-200/50 dark:border-slate-700/50 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center cursor-pointer group" onclick="switchView('terminology')">
                    <div class="icon-badge p-2.5 rounded-xl w-10 h-10 flex items-center justify-center transition-transform group-hover:scale-110">
                        <span class="material-icons-outlined text-white">trending_up</span>
                    </div>
                    <span class="ml-3 font-bold text-xl bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent">PredictionMarketPulse</span>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-1">
                    <button onclick="switchView('terminology')" id="nav-terminology" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">description</span>
                        Terminology
                    </button>
                    <button onclick="switchView('tracker')" id="nav-tracker" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">trending_up</span>
                        Tracker & Deals
                    </button>
                    <button onclick="switchView('network')" id="nav-network" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">hub</span>
                        Network Map
                    </button>
                    <button onclick="switchView('simulation')" id="nav-simulation" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">sports_esports</span>
                        Trading Simulation
                    </button>
                    <button onclick="switchView('about')" id="nav-about" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">info</span>
                        About
                    </button>
                    <button onclick="switchView('contact')" id="nav-contact" class="nav-btn flex items-center text-sm font-medium px-4 py-2 rounded-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                        <span class="material-icons-outlined text-base mr-2">email</span>
                        Contact
                    </button>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="ml-2 p-2 rounded-lg hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-800 transition-colors" title="Toggle dark mode">
                        <span class="material-icons-outlined text-xl dark:hidden">dark_mode</span>
                        <span class="material-icons-outlined text-xl hidden dark:inline">light_mode</span>
                    </button>
                </div>

                <!-- Mobile Menu Button & Dark Mode Toggle -->
                <div class="md:hidden flex items-center space-x-2">
                    <button id="dark-mode-toggle-mobile" onclick="toggleDarkMode()" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-800 transition-colors" title="Toggle dark mode">
                        <span class="material-icons-outlined dark:hidden text-xl">dark_mode</span>
                        <span class="material-icons-outlined hidden dark:inline text-xl">light_mode</span>
                    </button>
                    <button id="mobile-menu-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-800 transition-colors" onclick="toggleMobileMenu()">
                        <span class="material-icons-outlined text-xl">menu</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div id="mobile-menu" class="hidden md:hidden pb-4 pt-2 bg-white dark:bg-slate-800">
                <div class="flex flex-col space-y-2">
                    <button onclick="switchView('terminology'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">description</span>
                        Terminology
                    </button>
                    <button onclick="switchView('tracker'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">trending_up</span>
                        Tracker & Deals
                    </button>
                    <button onclick="switchView('network'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">hub</span>
                        Network Map
                    </button>
                    <button onclick="switchView('simulation'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">sports_esports</span>
                        Trading Simulation
                    </button>
                    <button onclick="switchView('about'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">info</span>
                        About
                    </button>
                    <button onclick="switchView('contact'); toggleMobileMenu()" class="nav-btn-mobile flex items-center text-sm font-medium text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg transition-all hover:bg-slate-50 dark:bg-slate-900 dark:hover:bg-slate-800 w-full text-left dark:text-slate-200">
                        <span class="material-icons-outlined text-base mr-3">email</span>
                        Contact
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="py-8 sm:py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <div id="view-terminology" class="view-content active">
                <div class="mb-16 text-center">
                    <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-slate-900 dark:text-slate-100 mb-4">
                        Understanding the <span class="hero-gradient">Prediction Market Ecosystem</span>
                    </h1>
                    <p class="text-lg text-slate-700 dark:text-slate-100 max-w-3xl mx-auto">
                        Your guide to the US prediction markets ecosystem — understanding the regulatory framework, tracking the partnerships shaping the industry, and exploring how trading works.
                    </p>
                </div>

                <!-- Market Structure Diagram -->
                <div class="space-y-16 max-w-6xl mx-auto">
                    <!-- The Regulators Section -->
                    <section>
                        <div class="flex items-center gap-4 mb-8">
                            <div class="p-3 bg-indigo-100 dark:bg-indigo-900 rounded-2xl w-14 h-14 flex items-center justify-center">
                                <span class="material-icons-outlined text-indigo-600 dark:text-indigo-300 text-2xl">shield</span>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100">The Regulators</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- CFTC Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">CFTC</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">Commodity Futures Trading Commission</p>
                                    </div>
                                    <span class="material-icons-outlined text-indigo-200 dark:text-indigo-700 text-4xl">gavel</span>
                                </div>
                                
                                <div class="space-y-4 mt-6">
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-2">Role</h4>
                                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed">The primary federal regulator of the U.S. derivatives markets, including futures, options on futures, and many swaps.</p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-2">Responsibilities</h4>
                                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed">Oversees trading to deter fraud, manipulation, abusive practices, and systemic risk, and to help ensure markets are fair, transparent, and financially sound.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- NFA Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">NFA</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">National Futures Association</p>
                                    </div>
                                    <span class="material-icons-outlined text-slate-200 dark:text-slate-600 text-4xl">verified_user</span>
                                </div>
                                
                                <div class="space-y-4 mt-6">
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-2">Role</h4>
                                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed">A CFTC-designated self-regulatory organization (SRO) for derivatives intermediaries such as FCMs, introducing brokers, commodity pool operators, and swap firms.</p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-2">Responsibilities</h4>
                                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed">Sets and enforces rules for its members, conducts examinations and audits, monitors financial and compliance requirements, and runs registration and background-screening functions for many CFTC registrants.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Market Participants Section -->
                    <section>
                        <div class="flex items-center gap-4 mb-8">
                            <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-2xl w-14 h-14 flex items-center justify-center">
                                <span class="material-icons-outlined text-purple-600 dark:text-purple-300 text-2xl">storefront</span>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 break-words">Market Participants/Designations</h2>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- FCM Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">FCM</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">Futures Commission Merchant</p>
                                    </div>
                                    <span class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-sm font-semibold rounded-lg whitespace-nowrap">CFTC & NFA Regulated</span>
                                </div>
                                
                                <p class="text-slate-700 dark:text-slate-100 leading-relaxed mt-6 mb-6 flex-grow">A firm that facilitates customer access to futures and options markets (and certain swaps or event contracts), accepts customer funds to margin those positions, and is subject to oversight by both the CFTC and NFA.</p>
                                
                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-3">Examples</h4>
                                    <p class="text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg">PrizePicks (Performance Predictions II), Robinhood Derivatives</p>
                                </div>
                            </div>

                            <!-- DCM Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">DCM</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">Designated Contract Market</p>
                                    </div>
                                    <span class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-sm font-semibold rounded-lg whitespace-nowrap">CFTC Regulated</span>
                                </div>
                                
                                <p class="text-slate-700 dark:text-slate-100 leading-relaxed mt-6 mb-6 flex-grow">A CFTC-regulated exchange (board of trade) where standardized futures, options on futures, and certain swaps or event contracts are listed and traded.</p>
                                
                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-3">Examples</h4>
                                    <p class="text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg">CME, Kalshi, Polymarket US (QCX), Crypto.com (CDNA)</p>
                                </div>
                            </div>

                            <!-- DCO Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">DCO</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">Derivatives Clearing Organization</p>
                                    </div>
                                    <span class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-sm font-semibold rounded-lg whitespace-nowrap">CFTC Regulated</span>
                                </div>
                                
                                <p class="text-slate-700 dark:text-slate-100 leading-relaxed mt-6 mb-6 flex-grow">A CFTC-registered clearinghouse that clears and settles trades—often those executed on DCMs—and manages the associated margin and counterparty risk.</p>
                                
                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-3">Examples</h4>
                                    <p class="text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg">CME Clearing, Kalshi Klear, Polymarket Clearing (QC Clearing)</p>
                                </div>
                            </div>

                            <!-- IB Card -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">IB</h3>
                                        <p class="text-indigo-600 dark:text-indigo-300 font-semibold">Introducing Broker</p>
                                    </div>
                                    <span class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-sm font-semibold rounded-lg whitespace-nowrap">NFA Registered</span>
                                </div>
                                
                                <p class="text-slate-700 dark:text-slate-100 leading-relaxed mt-6 mb-6 flex-grow">A CFTC-registered intermediary that solicits or accepts customer orders but does not hold customer funds; instead, it "introduces" those accounts to an FCM that carries the positions.</p>
                                
                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 dark:text-slate-200 uppercase tracking-wider mb-3">Examples</h4>
                                    <p class="text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg">Fanatics (via Paragon Global Markets), DraftKings Predictions</p>
                                </div>
                            </div>
                        </div>
                    </section>
                <section class="mb-16">
                    <div class="bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-3xl p-8 md:p-12 border border-slate-200 dark:border-slate-700 shadow-xl relative overflow-hidden">
                        <!-- Decorative background elements -->
                        <div class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-indigo-100/30 to-purple-100/30 rounded-full blur-3xl -z-0"></div>
                        <div class="absolute bottom-0 left-0 w-96 h-96 bg-gradient-to-tr from-blue-100/30 to-cyan-100/30 rounded-full blur-3xl -z-0"></div>
                        
                        <div class="relative z-10">
                            <div class="text-center mb-8">
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">Market Structure Flow</h2>
                                <p class="text-slate-700 dark:text-slate-100">How trades move through the prediction markets ecosystem</p>
                            </div>
                            
                            <div class="max-w-6xl mx-auto">
                                <!-- Modern Card-Based Flow -->
                                <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-1 xl:gap-3 overflow-x-auto pb-4">
                                    
                                    <!-- Customer Node -->
                                    <div class="flex flex-col items-center flex-shrink-0">
                                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 border-2 border-slate-200 dark:border-slate-700 hover:border-slate-300 transition-all duration-300 hover:shadow-xl group w-36 md:w-40 min-h-[140px]">
                                            <div class="flex flex-col items-center">
                                                <div class="w-12 h-12 bg-gradient-to-br from-slate-400 to-slate-600 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                    </svg>
                                                </div>
                                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-center mb-1 text-xs">Customer</h3>
                                                <p class="text-xs text-slate-600 dark:text-slate-300 text-center text-[10px]">Individual Trader</p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400 mt-2 font-medium">START</div>
                                    </div>
                                    
                                    <!-- Arrow 1 -->
                                    <div class="hidden md:flex items-center flex-shrink-0">
                                        <div class="flex items-center">
                                            <div class="h-0.5 w-4 bg-gradient-to-r from-slate-300 to-indigo-400"></div>
                                            <div class="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-8 border-l-indigo-400"></div>
                                        </div>
                                    </div>
                                    <div class="md:hidden flex flex-col items-center">
                                        <div class="w-0.5 h-8 bg-gradient-to-b from-slate-300 to-indigo-400"></div>
                                        <div class="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-8 border-t-indigo-400"></div>
                                    </div>
                                    
                                    <!-- IB/FCM/TSP Node -->
                                    <div class="flex flex-col items-center flex-shrink-0">
                                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 border-2 border-indigo-300 hover:border-indigo-400 transition-all duration-300 hover:shadow-xl group w-36 md:w-40 min-h-[140px] relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 opacity-50"></div>
                                            <div class="relative flex flex-col items-center">
                                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                                    </svg>
                                                </div>
                                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-center mb-1 text-xs">IB / Non-Clearing FCM / TSP</h3>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 text-center leading-tight text-[10px]">Access Point</p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-indigo-600 dark:text-indigo-300 mt-2 font-semibold">STEP 1</div>
                                    </div>
                                    
                                    <!-- Arrow 2 -->
                                    <div class="hidden md:flex items-center flex-shrink-0">
                                        <div class="flex items-center">
                                            <div class="h-0.5 w-4 bg-gradient-to-r from-indigo-400 to-emerald-400"></div>
                                            <div class="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-8 border-l-emerald-400"></div>
                                        </div>
                                    </div>
                                    <div class="md:hidden flex flex-col items-center">
                                        <div class="w-0.5 h-8 bg-gradient-to-b from-indigo-400 to-emerald-400"></div>
                                        <div class="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-8 border-t-emerald-400"></div>
                                    </div>
                                    
                                    <!-- FCM Node -->
                                    <div class="flex flex-col items-center flex-shrink-0">
                                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 border-2 border-emerald-300 hover:border-emerald-400 transition-all duration-300 hover:shadow-xl group w-36 md:w-40 min-h-[140px] relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 opacity-50"></div>
                                            <div class="relative flex flex-col items-center">
                                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                                    </svg>
                                                </div>
                                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-center mb-1 text-xs">FCM</h3>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 text-center leading-tight text-[10px]">Clearing & Custody</p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-emerald-600 dark:text-emerald-300 mt-2 font-semibold">STEP 2</div>
                                    </div>
                                    
                                    <!-- Arrow 3 -->
                                    <div class="hidden md:flex items-center flex-shrink-0">
                                        <div class="flex items-center">
                                            <div class="h-0.5 w-4 bg-gradient-to-r from-emerald-400 to-blue-400"></div>
                                            <div class="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-8 border-l-blue-400"></div>
                                        </div>
                                    </div>
                                    <div class="md:hidden flex flex-col items-center">
                                        <div class="w-0.5 h-8 bg-gradient-to-b from-emerald-400 to-blue-400"></div>
                                        <div class="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-8 border-t-blue-400"></div>
                                    </div>
                                    
                                    <!-- DCM Node -->
                                    <div class="flex flex-col items-center flex-shrink-0">
                                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 border-2 border-blue-300 hover:border-blue-400 transition-all duration-300 hover:shadow-xl group w-36 md:w-40 min-h-[140px] relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 opacity-50"></div>
                                            <div class="relative flex flex-col items-center">
                                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                                    </svg>
                                                </div>
                                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-center mb-1 text-xs">DCM</h3>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 text-center leading-tight text-[10px]">Exchange/Market</p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-blue-600 dark:text-blue-300 mt-2 font-semibold">STEP 3</div>
                                    </div>
                                    
                                    <!-- Arrow 4 -->
                                    <div class="hidden md:flex items-center flex-shrink-0">
                                        <div class="flex items-center">
                                            <div class="h-0.5 w-4 bg-gradient-to-r from-blue-400 to-purple-400"></div>
                                            <div class="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-8 border-l-purple-400"></div>
                                        </div>
                                    </div>
                                    <div class="md:hidden flex flex-col items-center">
                                        <div class="w-0.5 h-8 bg-gradient-to-b from-blue-400 to-purple-400"></div>
                                        <div class="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-8 border-t-purple-400"></div>
                                    </div>
                                    
                                    <!-- DCO Node -->
                                    <div class="flex flex-col items-center flex-shrink-0">
                                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 border-2 border-purple-300 hover:border-purple-400 transition-all duration-300 hover:shadow-xl group w-36 md:w-40 min-h-[140px] relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 opacity-50"></div>
                                            <div class="relative flex flex-col items-center">
                                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                </div>
                                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-center mb-1 text-xs">DCO</h3>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 text-center leading-tight text-[10px]">Settlement</p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-purple-600 dark:text-purple-300 mt-2 font-semibold">STEP 4</div>
                                    </div>
                                    
                                </div>
                                
                                <!-- Info Cards Below -->
                                <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white/60 dark:bg-slate-800/90 backdrop-blur-sm rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 min-w-8 min-h-8 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <span class="text-indigo-600 dark:text-indigo-300 font-bold text-sm">IB</span>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-slate-900 dark:text-slate-100 text-sm mb-1">Introducing Broker</h4>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 leading-relaxed">Solicits customers but doesn't hold funds</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white/60 dark:bg-slate-800/90 backdrop-blur-sm rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 min-w-8 min-h-8 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <span class="text-emerald-600 dark:text-emerald-300 font-bold text-xs">FCM</span>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-slate-900 dark:text-slate-100 text-sm mb-1">Futures Commission Merchant</h4>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 leading-relaxed">Accepts and holds customer funds for trading</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white/60 dark:bg-slate-800/90 backdrop-blur-sm rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 min-w-8 min-h-8 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <span class="text-slate-700 dark:text-slate-100 font-bold text-xs">TSP</span>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-slate-900 dark:text-slate-100 text-sm mb-1">Tech Service Provider</h4>
                                                <p class="text-xs text-slate-700 dark:text-slate-100 leading-relaxed">Provides technology platform and services</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bottom Note -->
                                <div class="mt-8 bg-gradient-to-r from-slate-50 to-indigo-50 dark:from-slate-800 dark:to-indigo-950 rounded-xl p-6 border border-slate-200 dark:border-slate-700">
                                    <div class="flex items-start gap-4">
                                        <div class="w-10 h-10 min-w-10 min-h-10 bg-indigo-100 dark:bg-indigo-900 rounded-xl flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">Note on Multi-Role Entities</h4>
                                            <p class="text-sm text-slate-700 dark:text-slate-100 leading-relaxed">Some organizations may serve multiple roles simultaneously. For example, CME functions as both an FCM, DCM, and DCO. The flow shown represents the logical progression of a trade through the system, even when roles are consolidated within a single entity.</p>
                                            <p class="text-sm text-slate-700 dark:text-slate-100 leading-relaxed mt-2">In certain prediction market structures, introducing intermediaries may operate without a separate FCM because customer clearing is handled directly by the exchange or its clearing organization.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                    <!-- Useful Links Section -->

                    <section class="mt-16">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="p-3 bg-emerald-100 dark:bg-emerald-900 rounded-2xl w-14 h-14 flex items-center justify-center">
                                <span class="material-icons-outlined text-emerald-600 dark:text-emerald-300 text-2xl">link</span>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100">Useful Links</h2>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div class="space-y-4">
                                <div class="flex items-start gap-3">
                                    <span class="material-icons-outlined text-indigo-500 text-xl mt-0.5">open_in_new</span>
                                    <div>
                                        <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">Search NFA Filings</h3>
                                        <a href="https://www.nfa.futures.org/basicnet/" target="_blank" class="text-indigo-600 dark:text-indigo-300 hover:text-indigo-700 text-sm break-all">https://www.nfa.futures.org/basicnet/</a>
                                    </div>
                                </div>
                                
                                <div class="border-t border-slate-100 dark:border-slate-700"></div>
                                
                                <div class="flex items-start gap-3">
                                    <span class="material-icons-outlined text-indigo-500 text-xl mt-0.5">open_in_new</span>
                                    <div>
                                        <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">Search CFTC Filing Status (DCM and DCO Registrations)</h3>
                                        <a href="https://www.cftc.gov/IndustryOversight/IndustryFilings/TradingOrganizations?dir=ASC&col=Status" target="_blank" class="text-indigo-600 dark:text-indigo-300 hover:text-indigo-700 text-sm break-all">https://www.cftc.gov/IndustryOversight/IndustryFilings/TradingOrganizations</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <div id="view-tracker" class="view-content">
                <div class="mb-10">
                    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-3">Partnership <span class="hero-gradient">Tracker</span></h1>
                    <p class="text-slate-700 dark:text-slate-100 mb-8 text-lg">Detailed breakdown of market structure relationships.</p>
                    
                    <div class="flex gap-4 items-center flex-wrap">
                        <select id="typeFilter" onchange="filterPartnerships()" class="filter-select px-5 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 text-sm font-medium shadow-sm hover:border-indigo-300 transition-all focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Types</option>
                            <option value="Acquisition">Acquisition</option>
                            <option value="Capital/Collaboration">Capital/Collaboration</option>
                            <option value="Capital/Marketing">Capital/Marketing</option>
                            <option value="Data/Integration">Data/Integration</option>
                            <option value="Data/Marketing">Data/Marketing</option>
                            <option value="Data/Marketing/Sponsorship">Data/Marketing/Sponsorship</option>
                            <option value="Government Affairs">Government Affairs</option>
                            <option value="Marketing/Athlete Sponsorship">Marketing/Athlete Sponsorship</option>
                            <option value="Operational">Operational</option>
                            <option value="Operational/B2B">Operational/B2B</option>
                            <option value="Operational/Data">Operational/Data</option>
                            <option value="Other">Other</option>
                        </select>
                        
                        <input type="text" id="searchInput" oninput="filterPartnerships()" placeholder="Search partnerships..." class="search-input flex-1 min-w-[200px] px-5 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 text-sm shadow-sm hover:border-indigo-300 transition-all">
                    </div>
                </div>

                <div id="tracker-content" class="space-y-6"></div>
            </div>

            <div id="view-network" class="view-content">
                <div class="mb-6">
                    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-3">Ecosystem <span class="hero-gradient">Network Map</span></h1>
                    <p class="text-slate-700 dark:text-slate-100 text-lg mb-6">Interactive visualization of prediction market partnerships and regulatory relationships.</p>
                </div>

                <div class="network-controls">
                    <select id="graphTypeFilter" onchange="filterGraph()">
                        <option value="">All Types</option>
                        <option value="Acquisition">Acquisition</option>
                        <option value="Capital/Collaboration">Capital/Collaboration</option>
                        <option value="Capital/Marketing">Capital/Marketing</option>
                        <option value="Data/Integration">Data/Integration</option>
                        <option value="Data/Marketing">Data/Marketing</option>
                        <option value="Data/Marketing/Sponsorship">Data/Marketing/Sponsorship</option>
                        <option value="Government Affairs">Government Affairs</option>
                        <option value="Marketing/Athlete Sponsorship">Marketing/Athlete Sponsorship</option>
                        <option value="Operational">Operational</option>
                        <option value="Operational/B2B">Operational/B2B</option>
                        <option value="Operational/Data">Operational/Data</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="graphSearchInput" oninput="searchGraph()" placeholder="Search entities...">
                    <button class="btn-reset" id="graphToggleAll" onclick="toggleShowAll()">
                        <span class="material-icons-outlined text-base">visibility_off</span>
                        <span id="toggleAllLabel">Focused</span>
                    </button>
                    <button class="btn-reset" onclick="resetGraphView()">
                        <span class="material-icons-outlined text-base">refresh</span>
                        Reset View
                    </button>
                </div>

                <div class="graph-questions" id="graphQuestions">
                    <button class="graph-chip" data-question="mostConnected">Most Connected</button>
                    <button class="graph-chip" data-question="polymarket">Polymarket's Network</button>
                    <button class="graph-chip" data-question="kalshi">Kalshi's Network</button>
                    <button class="graph-chip" data-question="operational">Operational Infrastructure</button>
                    <button class="graph-chip" data-question="acquisition">Acquisition Activity</button>
                    <button class="graph-chip" data-question="data">Data Partnerships</button>
                    <button class="graph-chip" data-question="tradfi">Traditional Finance</button>
                </div>

                <div class="network-container" id="networkContainer">
                    <div class="network-orb-1"></div>
                    <div class="network-orb-2"></div>
                    <svg class="network-svg" id="networkSvg"></svg>
                    <div class="graph-zoom-controls">
                        <button onclick="graphZoomIn()" title="Zoom In"><span class="material-icons-outlined" style="font-size:18px;">add</span></button>
                        <button onclick="graphZoomOut()" title="Zoom Out"><span class="material-icons-outlined" style="font-size:18px;">remove</span></button>
                        <button onclick="graphFitToView()" title="Fit to View"><span class="material-icons-outlined" style="font-size:18px;">fit_screen</span></button>
                    </div>
                    <div class="network-legend" id="networkLegend">
                        <div class="legend-item" data-node-type="Platform" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><circle cx="6" cy="6" r="5" fill="#6366f1" stroke="#4338ca" stroke-width="1.5"/></svg><span>Prediction Market</span></div>
                        <div class="legend-item" data-node-type="DCM" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><polygon points="6,1 11,4 10,10 2,10 1,4" fill="#10b981" stroke="#059669" stroke-width="1.5"/></svg><span>DCM</span></div>
                        <div class="legend-item" data-node-type="DCO" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><polygon points="6,1 11,6 6,11 1,6" fill="#3b82f6" stroke="#2563eb" stroke-width="1.5"/></svg><span>DCO</span></div>
                        <div class="legend-item" data-node-type="FCM" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><rect x="1" y="3" width="10" height="7" rx="2.5" fill="#f59e0b" stroke="#d97706" stroke-width="1.5"/></svg><span>FCM</span></div>
                        <div class="legend-item" data-node-type="IB" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><polygon points="6,2 11,10 1,10" fill="#ec4899" stroke="#db2777" stroke-width="1.5"/></svg><span>IB</span></div>
                        <div class="legend-item" data-node-type="TSP" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><polygon points="6,1 11,5 9,11 3,11 1,5" fill="#f43f5e" stroke="#e11d48" stroke-width="1.5"/></svg><span>TSP</span></div>
                        <div class="legend-item" data-node-type="Other" onclick="toggleLegendFilter(this)"><svg width="12" height="12"><rect x="1" y="1" width="10" height="10" rx="2" fill="#8b5cf6" stroke="#7c3aed" stroke-width="1.5"/></svg><span>Partner</span></div>
                        <div class="legend-divider"></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#10b981" stroke-width="2"/></svg><span>Operational</span></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#2563eb" stroke-width="2"/></svg><span>Data</span></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#7c3aed" stroke-width="2"/></svg><span>Capital</span></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#f97316" stroke-width="2"/></svg><span>Marketing</span></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#e11d48" stroke-width="2"/></svg><span>Acquisition</span></div>
                        <div class="legend-item" style="cursor:default;"><svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#facc15" stroke-width="2"/></svg><span>Government</span></div>
                    </div>
                    <div class="graph-tooltip" id="graphTooltip"></div>
                    <div class="graph-detail-panel" id="graphDetailPanel">
                        <button class="dp-close" onclick="closeDetailPanel()"><span class="material-icons-outlined" style="font-size:16px;">close</span></button>
                        <div id="graphDetailContent"></div>
                    </div>
                </div>
            </div>

            <div id="view-simulation" class="view-content">
                <div class="mb-6 hidden md:block">
                    <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-3">
                        Trading <span class="hero-gradient">Simulation</span>
                    </h1>
                    <p class="text-slate-600 dark:text-slate-400 text-lg">
                        Learn how prediction markets work by trading on a simple question: Will it rain tomorrow?
                    </p>
                </div>
                <div style="max-width:500px;margin:0 auto;">
                    <iframe id="sim-iframe" src="simulation.html" style="width:100%;border:none;border-radius:16px;" title="Weather Trader Simulation"></iframe>
                </div>
                <script>
                window.addEventListener('message',function(e){
                    if(e.data&&e.data.type==='sim-height'){
                        document.getElementById('sim-iframe').style.height=e.data.height+'px';
                    }
                    if(e.data&&e.data.type==='sim-scroll-top'&&window.innerWidth<=768){
                        document.getElementById('sim-iframe').scrollIntoView({behavior:'smooth'});
                    }
                });
                document.getElementById('sim-iframe').addEventListener('load',function(){
                    var isDark = document.documentElement.classList.contains('dark');
                    this.contentWindow.postMessage({type:'sim-theme', dark: isDark}, '*');
                });
                </script>
            </div>

            <div id="view-about" class="view-content">
                <div class="text-center mb-12">
                    <h1 class="text-4xl sm:text-6xl font-bold tracking-tight text-slate-900 dark:text-slate-100 mb-6">
                        About <span class="hero-gradient">PredictionMarketPulse</span>
                    </h1>
                </div>
                
                <div class="max-w-3xl mx-auto space-y-8">
                    <!-- Main Description -->
                    <div class="section-card rounded-2xl shadow-xl p-10 border border-slate-200 dark:border-slate-700">
                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-6 text-lg">
                            This site is an independent project that explains the structure and partnerships behind prediction markets—how they're organized and who's involved.
                        </p>
                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-6 text-lg">
                            As the space has evolved, we found the news hard to follow and the underlying relationships even harder to untangle. This site brings those pieces together in one place for anyone looking for clarity.
                        </p>
                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed text-lg">
                            This site will be regularly updated as new deals are announced to keep the information current and comprehensive.
                        </p>
                    </div>

                    <!-- About the Creators -->
                    <div class="section-card rounded-2xl shadow-xl p-10 border border-slate-200 dark:border-slate-700">
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-6">About the Creators</h2>
                        
                        <!-- Josh Pearl -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-3">Josh Pearl</h3>
                            <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-4">
                                Josh has spent over a decade working in regulated gambling, spanning online horse racing, sports wagering, online casino, and paid fantasy sports. He previously led new-state launch efforts at Penn Interactive, working closely on legislative, regulatory, and operational considerations.
                            </p>
                            <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-4">
                                He now consults with regulated gambling companies across a wide range of initiatives. Josh has followed prediction markets closely since early 2025 out of personal interest and has no business affiliation with any entities participating in this space.
                            </p>
                            <a href="https://www.linkedin.com/in/joshua-pearl-14b73627/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-indigo-600 dark:text-indigo-400 hover:underline text-sm font-medium">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                </svg>
                                LinkedIn Profile
                            </a>
                        </div>

                        <!-- Grant Hartman -->
                        <div class="pt-8 border-t border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-3">Grant Hartman</h3>
                            <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-4">
                                Grant works as Director of Client Engagement at <a href="https://chariotsolutions.com" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 hover:underline">Chariot Solutions</a>, where he works closely with clients building software in complex, highly regulated markets, including gaming, sports betting, and prediction markets. Through this work, he's spent years close to projects shaped by regulation, incentives, and technology.
                            </p>
                            <a href="https://www.linkedin.com/in/ghartman/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-indigo-600 dark:text-indigo-400 hover:underline text-sm font-medium">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                </svg>
                                LinkedIn Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-contact" class="view-content">
                <div class="text-center mb-12">
                    <h1 class="text-4xl sm:text-6xl font-bold tracking-tight text-slate-900 dark:text-slate-100 mb-6">
                        Get in <span class="hero-gradient">Touch</span>
                    </h1>
                </div>
                
                <div class="max-w-2xl mx-auto">
                    <div class="section-card rounded-2xl shadow-xl p-10 border border-slate-200 dark:border-slate-700">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-6 shadow-lg">
                                <span class="material-icons-outlined text-white text-4xl">email</span>
                            </div>
                        </div>
                        
                        <p class="text-slate-700 dark:text-slate-100 leading-relaxed mb-8 text-lg text-center">
                            We welcome feedback, suggestions for partnerships to add to our tracker, or just a friendly hello. We'd love to hear from you!
                        </p>
                        
                        <!-- Netlify Form -->
                        <form name="contact" method="POST" data-netlify="true" netlify-honeypot="bot-field" action="/success.html" class="space-y-6">
                            <!-- Hidden fields for Netlify -->
                            <input type="hidden" name="form-name" value="contact" />
                            
                            <!-- Honeypot for spam protection -->
                            <p class="hidden">
                                <label>Don't fill this out if you're human: <input name="bot-field" /></label>
                            </p>
                            
                            <!-- Name Field -->
                            <div>
                                <label for="name" class="block text-sm font-semibold text-slate-700 dark:text-slate-100 mb-2">
                                    Name <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="name" 
                                    name="name" 
                                    required
                                    class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition-all"
                                    placeholder="Your name"
                                />
                            </div>
                            
                            <!-- Email Field -->
                            <div>
                                <label for="email" class="block text-sm font-semibold text-slate-700 dark:text-slate-100 mb-2">
                                    Email <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    required
                                    class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition-all"
                                    placeholder="your@email.com"
                                />
                            </div>
                            
                            <!-- Subject Field -->
                            <div>
                                <label for="subject" class="block text-sm font-semibold text-slate-700 dark:text-slate-100 mb-2">
                                    Subject
                                </label>
                                <input 
                                    type="text" 
                                    id="subject" 
                                    name="subject"
                                    class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition-all"
                                    placeholder="What's this about?"
                                />
                            </div>
                            
                            <!-- Message Field -->
                            <div>
                                <label for="message" class="block text-sm font-semibold text-slate-700 dark:text-slate-100 mb-2">
                                    Message <span class="text-red-500">*</span>
                                </label>
                                <textarea 
                                    id="message" 
                                    name="message" 
                                    rows="6"
                                    required
                                    class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition-all resize-none"
                                    placeholder="Your message..."
                                ></textarea>
                            </div>
                            
                            <!-- Submit Button -->
                            <div class="text-center">
                                <button 
                                    type="submit"
                                    class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
                                >
                                    <span class="material-icons-outlined mr-2">send</span>
                                    Send Message
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1NCU6XnJDrVpFkQuoqiyFijf66HozqUNpjLdaL5Hzxtk/gviz/tq?tqx=out:csv&sheet=Model%20Layout%20(%3F)';

        let partnershipsData = [];

        function loadData() {
            const container = document.getElementById('tracker-content');
            container.innerHTML = '<p class="text-center text-slate-500 py-8">Loading partnerships...</p>';

            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: 'greedy',
                complete: function(results) {
                    partnershipsData = results.data.filter(row => row.Partnership && row.Partnership.trim() && String(row.Published || '').trim().toLowerCase() === 'yes');
                    renderTracker();
                    // If network view is already active (direct navigation via hash), init the graph now
                    if (!networkGraphInitialized && document.getElementById('view-network').classList.contains('active')) {
                        setTimeout(initNetworkGraph, 50);
                    }
                },
                error: function(err) {
                    console.error('Failed to fetch sheet data:', err);
                    container.innerHTML = '<p class="text-center text-red-500 dark:text-red-400 py-8">Unable to load partnership data. Please try refreshing.</p>';
                }
            });
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'nav-active');
            });
            
            document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
                btn.classList.remove('text-primary', 'nav-active');
            });
            
            document.getElementById('view-' + viewName).classList.add('active');
            const navBtn = document.getElementById('nav-' + viewName);
            if (navBtn) {
                navBtn.classList.add('text-primary', 'nav-active');
            }

            const navBtnMobile = document.querySelector(`.nav-btn-mobile[onclick*="${viewName}"]`);
            if (navBtnMobile) {
                navBtnMobile.classList.add('text-primary', 'nav-active');
            }
            history.replaceState(null, '', '#' + viewName);

            // Lazy init network graph
            if (viewName === 'network' && !networkGraphInitialized && partnershipsData.length) {
                setTimeout(initNetworkGraph, 50);
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            const icon = btn.querySelector('.material-icons-outlined');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.textContent = 'close';
            } else {
                menu.classList.add('hidden');
                icon.textContent = 'menu';
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            }
            const simIframe = document.getElementById('sim-iframe');
            if (simIframe && simIframe.contentWindow) {
                simIframe.contentWindow.postMessage({type:'sim-theme', dark: !isDark}, '*');
            }
            updateGraphColors();
        }

        // Initialize dark mode on page load
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true' || (!darkMode && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        // Call this immediately
        initDarkMode();

        function renderTracker() {
            const container = document.getElementById('tracker-content');
            
            if (!partnershipsData.length) {
                container.innerHTML = '<p class="text-center text-slate-500">No data available</p>';
                return;
            }

            const typeFilter = document.getElementById('typeFilter')?.value || '';
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            const filtered = partnershipsData.filter(p => {
                const matchesType = !typeFilter || p['Type of Partnership'] === typeFilter;
                const matchesSearch = !searchQuery || 
                    p.Partnership?.toLowerCase().includes(searchQuery) ||
                    (p['Additional Details'] || '').toLowerCase().includes(searchQuery);
                return matchesType && matchesSearch;
            });

            // Sort by partnership type
            const typeOrder = {
                'Operational': 1,
                'Operational/Data': 2,
                'Operational/B2B': 3,
                'Data/Marketing': 4,
                'Data/Marketing/Sponsorship': 5,
                'Data/Integration': 6,
                'Capital/Collaboration': 7,
                'Capital/Marketing': 8,
                'Acquisition': 9,
                'Marketing/Athlete Sponsorship': 10,
                'Government Affairs': 11,
                'Other': 12
            };

            filtered.sort((a, b) => {
                const typeA = a['Type of Partnership'] || 'Other';
                const typeB = b['Type of Partnership'] || 'Other';
                const orderA = typeOrder[typeA] || 99;
                const orderB = typeOrder[typeB] || 99;
                return orderA - orderB;
            });

            let html = '';
            
            filtered.forEach(p => {
                const type = p['Type of Partnership'] || 'Other';
                const typeClass = type.includes('Data') ? 'Data' :
                                 type.includes('Operational') ? 'Operational' :
                                 type.includes('Acquisition') ? 'Acquisition' :
                                 type.includes('Investment') || type.includes('Capital') ? 'Capital' :
                                 type.includes('Government') ? 'Government' :
                                 type === 'Marketing/Athlete Sponsorship' ? 'Marketing' : 'Other';
                
                const badgeColor = 'badge-' + typeClass;
                
                const details = p['Additional Details'] || '';
                const hasRegulatory = !type.includes('Data') && !type.includes('Investment') && !type.includes('Capital') && !type.includes('Government') && (p.IB || p.FCM || p.DCM || p.DCO);
                
                html += `
                    <div class="partnership-card rounded-2xl overflow-hidden shadow-lg">
                        <div class="p-8 pb-6">
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-6">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 flex-1">${(p.Partnership || 'Untitled Partnership').replace(/\//g, ' <span class="material-icons-outlined text-indigo-400 text-lg mx-1" style="vertical-align: middle;">arrow_forward</span> ')}</h3>
                                <span class="text-xs font-bold px-3 sm:px-4 py-2 rounded-full ${badgeColor} uppercase tracking-wider text-center break-words whitespace-normal sm:whitespace-nowrap inline-block">${type}</span>
                            </div>
                            
                            ${hasRegulatory ? `
                            <div class="regulatory-box mb-6 rounded-xl p-5 border border-slate-200 dark:border-slate-700">
                                <h4 class="reg-label mb-4">Regulatory Structure</h4>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-5">
                                    ${p.IB && p.IB !== 'N/A' ? `
                                    <div>
                                        <div class="reg-label mb-2">IB</div>
                                        <div class="text-sm font-semibold text-slate-800 dark:text-slate-100">${p.IB}</div>
                                    </div>
                                    ` : ''}
                                    ${p.FCM && p.FCM !== 'N/A' ? `
                                    <div>
                                        <div class="reg-label mb-2">FCM</div>
                                        <div class="text-sm font-semibold text-slate-800 dark:text-slate-100">${p.FCM}</div>
                                    </div>
                                    ` : ''}
                                    ${p.DCM && p.DCM !== 'N/A' ? `
                                    <div>
                                        <div class="reg-label mb-2">DCM</div>
                                        <div class="text-sm font-semibold text-slate-800 dark:text-slate-100">${p.DCM}</div>
                                    </div>
                                    ` : ''}
                                    ${p.DCO && p.DCO !== 'N/A' ? `
                                    <div>
                                        <div class="reg-label mb-2">DCO</div>
                                        <div class="text-sm font-semibold text-slate-800 dark:text-slate-100">${p.DCO}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${details && details.trim() ? `
                            <div class="mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="info-icon material-icons-outlined text-sm mt-0.5 flex-shrink-0">info</span>
                                    <div class="flex-1">
                                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Details</span>
                                        <div class="text-sm text-slate-700 dark:text-slate-200 mt-2 leading-relaxed">${(() => {
                                            const items = details.trim().split(/(?:\n|(?<=\S)\s*-\s+(?=[A-Z]))/).map(line => line.trim().replace(/^-\s*/, '')).filter(Boolean);
                                            if (items.length > 1) {
                                                return items.map(item => '<div class="flex items-start gap-2 mt-1"><span class="text-indigo-500 mt-1">•</span><span>' + item + '</span></div>').join('');
                                            } else {
                                                return '<p>' + items[0] + '</p>';
                                            }
                                        })()}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${p['Announcement Link'] ? `
                        <div class="px-8 pb-6">
                            <a href="${p['Announcement Link']}" target="_blank" class="announcement-link">
                                <span>Announcement</span>
                                <span class="material-icons-outlined">arrow_forward</span>
                            </a>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-center text-slate-600 dark:text-slate-200 py-8">No partnerships found</p>';
        }

        function filterPartnerships() {
            renderTracker();
        }

        // ========================================
        // NETWORK GRAPH
        // ========================================
        let networkGraphInitialized = false;
        let graphSimulation = null;
        let graphZoom = null;
        let graphNodes = [];
        let graphEdges = [];
        let graphSvg = null;
        let graphG = null;
        let selectedNode = null;
        let showAllNodes = true; // true = show all nodes including peripheral
        const hiddenNodeTypes = new Set();
        let activeGuidedQuestion = null;

        const GUIDED_QUESTIONS = {
            mostConnected: {
                action() {
                    const sorted = [...graphNodes].sort((a, b) => b.connections - a.connections);
                    const topIds = new Set(sorted.slice(0, 5).map(n => n.id));
                    graphG.selectAll('.node-group')
                        .classed('highlighted', n => topIds.has(n.id))
                        .classed('dimmed', n => !topIds.has(n.id))
                        .each(function(n) {
                            const shape = d3.select(this).select('.node-shape');
                            shape.attr('filter', topIds.has(n.id) ? `url(#nodeGlow-${n.type})` : null);
                        });
                    graphG.selectAll('.edge-line')
                        .classed('highlighted', e => {
                            const s = typeof e.source === 'object' ? e.source.id : e.source;
                            const t = typeof e.target === 'object' ? e.target.id : e.target;
                            return topIds.has(s) && topIds.has(t);
                        })
                        .classed('dimmed', e => {
                            const s = typeof e.source === 'object' ? e.source.id : e.source;
                            const t = typeof e.target === 'object' ? e.target.id : e.target;
                            return !(topIds.has(s) && topIds.has(t));
                        });
                }
            },
            polymarket: {
                action() {
                    const node = graphNodes.find(n => n.name.toLowerCase().includes('polymarket'));
                    if (node) updateGraphHighlight(node);
                }
            },
            kalshi: {
                action() {
                    const node = graphNodes.find(n => n.name.toLowerCase().includes('kalshi'));
                    if (node) updateGraphHighlight(node);
                }
            },
            operational: {
                action() {
                    document.getElementById('graphTypeFilter').value = 'Operational';
                    filterGraph();
                }
            },
            acquisition: {
                action() {
                    document.getElementById('graphTypeFilter').value = 'Acquisition';
                    filterGraph();
                }
            },
            data: {
                action() {
                    document.getElementById('graphTypeFilter').value = 'Data/Integration';
                    filterGraph();
                }
            },
            tradfi: {
                action() {
                    const tradfiIds = new Set();
                    graphNodes.forEach(n => {
                        if (n.type === 'FCM' || n.type === 'IB') tradfiIds.add(n.id);
                    });
                    graphG.selectAll('.node-group')
                        .classed('highlighted', n => tradfiIds.has(n.id))
                        .classed('dimmed', n => !tradfiIds.has(n.id))
                        .each(function(n) {
                            const shape = d3.select(this).select('.node-shape');
                            shape.attr('filter', tradfiIds.has(n.id) ? `url(#nodeGlow-${n.type})` : null);
                        });
                    graphG.selectAll('.edge-line')
                        .classed('highlighted', e => {
                            const s = typeof e.source === 'object' ? e.source.id : e.source;
                            const t = typeof e.target === 'object' ? e.target.id : e.target;
                            return tradfiIds.has(s) || tradfiIds.has(t);
                        })
                        .classed('dimmed', e => {
                            const s = typeof e.source === 'object' ? e.source.id : e.source;
                            const t = typeof e.target === 'object' ? e.target.id : e.target;
                            return !tradfiIds.has(s) && !tradfiIds.has(t);
                        });
                }
            }
        };

        function handleGuidedQuestion(key) {
            if (!networkGraphInitialized) return;
            const chip = document.querySelector(`.graph-chip[data-question="${key}"]`);
            // Toggle off if same chip clicked again
            if (activeGuidedQuestion === key) {
                clearGuidedQuestion();
                return;
            }
            // Reset prior state
            clearGraphHighlight();
            document.getElementById('graphTypeFilter').value = '';
            document.getElementById('graphSearchInput').value = '';
            filterGraph();
            // Set active chip
            document.querySelectorAll('.graph-chip').forEach(c => c.classList.remove('active'));
            if (chip) chip.classList.add('active');
            activeGuidedQuestion = key;
            // Execute the question action
            GUIDED_QUESTIONS[key].action();
            // Reframe after a short delay
            setTimeout(() => graphFitToView(), 350);
        }

        function clearGuidedQuestion() {
            activeGuidedQuestion = null;
            document.querySelectorAll('.graph-chip').forEach(c => c.classList.remove('active'));
        }

        // Attach click handlers to chips
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.graph-chip[data-question]').forEach(chip => {
                chip.addEventListener('click', () => handleGuidedQuestion(chip.dataset.question));
            });
        });

        const NODE_COLORS = {
            Platform:  { fill: '#6366f1', stroke: '#4338ca', inner: '#818cf8', outer: '#4338ca', glow: 'rgba(99,102,241,0.4)' },
            DCM:       { fill: '#10b981', stroke: '#059669', inner: '#34d399', outer: '#059669', glow: 'rgba(16,185,129,0.4)' },
            DCO:       { fill: '#3b82f6', stroke: '#2563eb', inner: '#60a5fa', outer: '#2563eb', glow: 'rgba(59,130,246,0.4)' },
            FCM:       { fill: '#f59e0b', stroke: '#d97706', inner: '#fbbf24', outer: '#d97706', glow: 'rgba(245,158,11,0.4)' },
            IB:        { fill: '#ec4899', stroke: '#db2777', inner: '#f472b6', outer: '#db2777', glow: 'rgba(236,72,153,0.4)' },
            TSP:       { fill: '#f43f5e', stroke: '#e11d48', inner: '#fb7185', outer: '#e11d48', glow: 'rgba(244,63,94,0.4)' },
            Other:     { fill: '#8b5cf6', stroke: '#7c3aed', inner: '#a78bfa', outer: '#7c3aed', glow: 'rgba(139,92,246,0.35)' }
        };

        const EDGE_COLORS = {
            Operational: '#10b981',
            Data: '#2563eb',
            Capital: '#7c3aed',
            Investment: '#7c3aed',
            Marketing: '#f97316',
            Acquisition: '#e11d48',
            Government: '#facc15',
            Other: '#64748b'
        };

        function getEdgeColor(type) {
            if (!type) return EDGE_COLORS.Other;
            for (const key of Object.keys(EDGE_COLORS)) {
                if (type.includes(key)) return EDGE_COLORS[key];
            }
            return EDGE_COLORS.Other;
        }

        function getEdgeCategory(type) {
            if (!type) return 'Other';
            if (type.includes('Operational')) return 'Operational';
            if (type.includes('Data') || type.includes('Integration')) return 'Data';
            if (type.includes('Capital') || type.includes('Investment')) return 'Capital';
            if (type.includes('Marketing') || type.includes('Sponsorship')) return 'Marketing';
            if (type.includes('Acquisition')) return 'Acquisition';
            if (type.includes('Government')) return 'Government';
            return 'Other';
        }

        // Prefix-based alias rules: if a name starts with the key (case-insensitive), map to value
        const ALIAS_PREFIXES = [
            // Subsidiaries — keep separate from parent platform, clean display names
            ['Coinbase Financial Markets', 'Coinbase Financial Markets'],
            ['FANDUEL PREDICTION MARKETS', 'FanDuel Prediction Markets'],
            ['Fanduel Predicts', 'FanDuel'],
            ['DraftKings Predictions', 'DraftKings Predictions'],
            ['PrizePicks (Performance', 'PrizePicks Predictions'],
            ['Robinhood Derivatives', 'Robinhood Derivatives'],
            // True aliases — same entity, different spellings
            ['Crypto.com (CDNA)', 'Crypto.com'],
            ['d/b/a Crypto.com', 'Crypto.com'],
            ['Paragon Global Markets LLC d/b/a Fanatics', 'Fanatics'],
            ['Fanatics Markets', 'Fanatics'],
            ['QCEX', 'Polymarket'],
            ['QCX LLC', 'Polymarket US (QCX)'],
            ['QC Clearing LLC', 'Polymarket Clearing'],
            ['Kalshi Klear', 'Kalshi Klear'],
            ['Kalshi (TBC)', 'Kalshi'],
            ['Kraken Derivatives', 'Kraken Derivatives'],
            ['Railbird Exchange', 'Railbird Exchange'],
            ['Gemini Titan', 'Gemini Titan'],
            ['TBC (NinjaTrader', 'NinjaTrader'],
            ['Chicago Mercantile Exchang', 'CME'],
            ['Options Clearing Corporati', 'OCC'],
            ['Sleeper Markets', 'Sleeper'],
            ['Webull Financial', 'WeBull Financial'],
            ['Small Exchange', 'Small Exchange'],
            ['MIAX Derivatives Exchange', 'MIAX Derivatives Exchange'],
        ];

        function normalizeEntityName(raw) {
            let name = raw.trim();
            if (!name || /^N\/A/i.test(name)) return null;
            if (/^TBD\b/i.test(name) || /^\(?(Assumed|TBD)\b/i.test(name)) return null;
            if (/^additional\s+notes$/i.test(name)) return null;

            // Check prefix aliases
            const nameLower = name.toLowerCase();
            for (const [prefix, canonical] of ALIAS_PREFIXES) {
                if (nameLower.startsWith(prefix.toLowerCase())) return canonical;
            }

            // Strip keyword-based trailing parentheticals
            name = name.replace(/\s*\((?:owned|pending|custodial|assumed|d\/b\/a|see|more)[^)]*\)\s*$/i, '').trim();
            // Strip short acronym trailing parentheticals like "(RHD)", "(MIAXdx)", "(CME)"
            name = name.replace(/\s*\([A-Za-z0-9]{1,10}\)\s*$/, '').trim();
            // Strip ", LLC", ", Inc", etc. and trailing asterisks
            name = name.replace(/,?\s*(LLC|Inc|Ltd|L\.P\.)\.?\s*\**\s*$/i, '').trim();
            // Strip trailing asterisks
            name = name.replace(/\*+$/, '').trim();

            // Strip "d/b/a" — take the part after it
            if (/\bd\/b\/a\b/i.test(name)) {
                const dbaMatch = name.match(/d\/b\/a\s+(.+)/i);
                if (dbaMatch) return dbaMatch[1].trim();
            }
            return name || null;
        }

        // Map of raw names → canonical names for deduplication
        const ENTITY_ALIASES = {};
        function registerAlias(raw, canonical) {
            ENTITY_ALIASES[raw.trim()] = canonical;
        }

        function resolveEntity(raw) {
            const trimmed = raw.trim();
            if (ENTITY_ALIASES[trimmed]) return ENTITY_ALIASES[trimmed];
            return trimmed;
        }

        function buildGraphData() {
            const nodeMap = {};
            const edgeMap = {};

            // Pre-scan to build alias table for duplicate entities
            // Collect all raw entity names first, then group by normalized form
            const rawNames = new Set();
            partnershipsData.forEach(p => {
                const partnershipName = (p.Partnership || '').trim();
                if (!partnershipName) return;
                partnershipName.split('/').map(s => s.trim()).filter(Boolean).forEach(n => rawNames.add(n));
                ['IB', 'FCM', 'DCM', 'DCO'].forEach(col => {
                    const v = (p[col] || '').trim();
                    if (v && v !== 'N/A') rawNames.add(v);
                });
            });

            // Build canonical name map: strip parentheticals, group similar names
            const canonicalGroups = {};
            rawNames.forEach(raw => {
                const norm = normalizeEntityName(raw);
                if (!norm) return;
                // Create a simple key: lowercase, strip "LLC", "Inc", commas, periods
                const simpleKey = norm.toLowerCase().replace(/[,.]| llc| inc| ltd| group/gi, '').replace(/\s+/g, ' ').trim();
                if (!canonicalGroups[simpleKey]) canonicalGroups[simpleKey] = [];
                canonicalGroups[simpleKey].push({ raw, norm });
            });

            // For each group, pick the shortest normalized name as canonical
            Object.values(canonicalGroups).forEach(group => {
                if (group.length <= 1) return;
                const canonical = group.reduce((a, b) => a.norm.length <= b.norm.length ? a : b).norm;
                group.forEach(entry => {
                    if (entry.raw !== canonical) {
                        registerAlias(entry.raw, canonical);
                    }
                });
            });

            function ensureNode(rawName, role) {
                const normalized = normalizeEntityName(rawName);
                if (!normalized) return null;
                const key = resolveEntity(normalized);
                if (!nodeMap[key]) {
                    nodeMap[key] = { id: key, name: key, roles: new Set(), partnerships: [], connections: 0 };
                }
                if (role) nodeMap[key].roles.add(role);
                return key;
            }

            function resolveRaw(raw) {
                const norm = normalizeEntityName(raw);
                if (!norm) return null;
                return resolveEntity(norm);
            }

            // Known prediction market platforms (get Platform type; everything else defaults to Other)
            const KNOWN_PLATFORMS = new Set([
                'Kalshi', 'Polymarket', 'Crypto.com', 'DraftKings', 'FanDuel',
                'Robinhood', 'Coinbase', 'Interactive Brokers', 'PrizePicks',
                'Sleeper', 'Sporttrade', 'ProphetX', 'Mojo Interactive',
                'Plus500', 'Galactic Markets', 'Novig', 'Matchbook', 'RSBIX',
                'Onyx Odds', 'High Roller Technologies', 'ForecastEx', 'MyPrize',
                'Gemini', 'WeBull', 'Phantom', 'DAZN',
            ]);

            const KNOWN_TSPS = new Set([
                'Underdog Fantasy', 'Dome',
            ]);

            // Entities with known regulatory roles when they appear as partners
            const KNOWN_ROLES = {
                'The Clearing Company': 'DCO',
            };

            // Compound entity names containing "&" that should NOT be split
            const COMPOUND_NAMES = new Set([
                'trump media & tech group',
                'madison square garden & new york rangers',
                'ufc & zuffa boxing',
            ]);

            function splitPartnerNames(partnershipName) {
                // Filter out junk rows
                if (/^additional notes$/i.test(partnershipName)) return [];
                // Filter out comma-separated note-style entries
                if (partnershipName.includes(',') && !partnershipName.includes('/')) return [];

                // First split on "/"
                const parts = partnershipName.split('/').map(s => s.trim()).filter(Boolean);

                // Then handle "&" within each part (but not inside parentheses)
                const result = [];
                parts.forEach(part => {
                    // Check if " & " exists outside of parentheses
                    const ampIdx = part.indexOf(' & ');
                    if (ampIdx === -1) {
                        result.push(part);
                        return;
                    }
                    // Don't split if the & is inside parentheses
                    const beforeAmp = part.substring(0, ampIdx);
                    if ((beforeAmp.match(/\(/g) || []).length > (beforeAmp.match(/\)/g) || []).length) {
                        result.push(part);
                        return;
                    }
                    // Check if this is a known compound name
                    if (COMPOUND_NAMES.has(part.toLowerCase())) {
                        result.push(part);
                    } else {
                        // Split on " & "
                        part.split(' & ').map(s => s.trim()).filter(Boolean).forEach(s => result.push(s));
                    }
                });
                return result;
            }

            partnershipsData.forEach(p => {
                const partnershipName = (p.Partnership || '').trim();
                if (!partnershipName) return;

                const type = p['Type of Partnership'] || 'Other';
                const rawPartners = splitPartnerNames(partnershipName);

                // Resolve all names — assign Platform, TSP, specific role, or no role
                const partners = rawPartners.map(n => {
                    const resolved = normalizeEntityName(n);
                    let role = null;
                    if (resolved && KNOWN_ROLES[resolved]) role = KNOWN_ROLES[resolved];
                    else if (resolved && KNOWN_PLATFORMS.has(resolved)) role = 'Platform';
                    else if (resolved && KNOWN_TSPS.has(resolved)) role = 'TSP';
                    return ensureNode(n, role);
                }).filter(Boolean);

                const ibKey = (p.IB || '').trim() && (p.IB || '').trim() !== 'N/A' ? ensureNode(p.IB, 'IB') : null;
                const fcmKey = (p.FCM || '').trim() && (p.FCM || '').trim() !== 'N/A' ? ensureNode(p.FCM, 'FCM') : null;
                const dcmKey = (p.DCM || '').trim() && (p.DCM || '').trim() !== 'N/A' ? ensureNode(p.DCM, 'DCM') : null;
                const dcoKey = (p.DCO || '').trim() && (p.DCO || '').trim() !== 'N/A' ? ensureNode(p.DCO, 'DCO') : null;

                // Collect all resolved entities in this partnership
                const allEntities = new Set(partners);
                [ibKey, fcmKey, dcmKey, dcoKey].forEach(k => { if (k) allEntities.add(k); });

                // Create edges between partners (the main partnership relationship)
                for (let i = 0; i < partners.length; i++) {
                    for (let j = i + 1; j < partners.length; j++) {
                        const edgeKey = [partners[i], partners[j]].sort().join('|||');
                        if (!edgeMap[edgeKey]) {
                            edgeMap[edgeKey] = { source: partners[i], target: partners[j], partnerships: [], weight: 0 };
                        }
                        edgeMap[edgeKey].partnerships.push({ name: partnershipName, type: type });
                        edgeMap[edgeKey].weight++;
                    }
                }

                // Create edges between partners and their regulatory entities
                partners.forEach(partner => {
                    [ibKey, fcmKey, dcmKey, dcoKey].forEach(regKey => {
                        if (!regKey || regKey === partner) return;
                        const edgeKey = [partner, regKey].sort().join('|||');
                        if (!edgeMap[edgeKey]) {
                            edgeMap[edgeKey] = { source: partner, target: regKey, partnerships: [], weight: 0 };
                        }
                        if (!edgeMap[edgeKey].partnerships.some(ep => ep.name === partnershipName)) {
                            edgeMap[edgeKey].partnerships.push({ name: partnershipName, type: type });
                            edgeMap[edgeKey].weight++;
                        }
                    });
                });

                // Record partnership on each involved node
                allEntities.forEach(eName => {
                    if (nodeMap[eName]) {
                        nodeMap[eName].partnerships.push({ name: partnershipName, type: type, details: p['Additional Details'] || '' });
                    }
                });
            });

            // Determine primary type for each node
            const typePriority = ['DCM', 'DCO', 'FCM', 'IB', 'TSP', 'Platform'];
            Object.values(nodeMap).forEach(node => {
                node.type = 'Other';
                for (const tp of typePriority) {
                    if (node.roles.has(tp)) { node.type = tp; break; }
                }
                const ROLE_LABELS = { Platform: 'Prediction Market' };
                node.rolesStr = Array.from(node.roles).map(r => ROLE_LABELS[r] || r).join(', ') || 'Partner';
            });

            // Count connections
            Object.values(edgeMap).forEach(edge => {
                if (nodeMap[edge.source]) nodeMap[edge.source].connections++;
                if (nodeMap[edge.target]) nodeMap[edge.target].connections++;
            });

            graphNodes = Object.values(nodeMap);
            graphEdges = Object.values(edgeMap);
        }

        function nodeRadius(d) {
            if (d.type === 'Other') {
                return Math.max(5, Math.min(16, 3 + d.connections * 1.8));
            }
            if (d.connections >= 8) {
                return Math.max(12, Math.min(34, 8 + d.connections * 2.8));
            }
            return Math.max(8, Math.min(26, 6 + d.connections * 2.2));
        }

        function drawNodeShape(sel) {
            sel.each(function(d) {
                const g = d3.select(this);
                g.selectAll('*').remove();
                const r = nodeRadius(d);
                const gradId = `url(#nodeGrad-${d.type})`;
                const strokeColor = (NODE_COLORS[d.type] || NODE_COLORS.Other).stroke;
                const fillColor = (NODE_COLORS[d.type] || NODE_COLORS.Other).fill;
                const sw = d.connections >= 8 ? 2.5 : 2;

                // Hub halo — pulsing ring for high-connection Platform nodes
                if (d.connections >= 8 && d.type === 'Platform') {
                    g.append('circle')
                        .attr('r', r + 6)
                        .attr('fill', 'none')
                        .attr('stroke', fillColor)
                        .attr('stroke-width', 1.5)
                        .attr('stroke-opacity', 0.3)
                        .attr('class', 'hub-halo');
                }

                let shape;
                if (d.type === 'Platform') {
                    shape = g.append('circle').attr('r', r);
                } else if (d.type === 'DCM') {
                    const pts = d3.range(6).map(i => {
                        const angle = (Math.PI / 3) * i - Math.PI / 2;
                        return [r * Math.cos(angle), r * Math.sin(angle)];
                    }).map(p => p.join(',')).join(' ');
                    shape = g.append('polygon').attr('points', pts);
                } else if (d.type === 'DCO') {
                    shape = g.append('polygon').attr('points', `0,${-r} ${r},0 0,${r} ${-r},0`);
                } else if (d.type === 'FCM') {
                    shape = g.append('rect').attr('x', -r).attr('y', -r * 0.65).attr('width', r * 2).attr('height', r * 1.3).attr('rx', r * 0.35);
                } else if (d.type === 'IB') {
                    shape = g.append('polygon').attr('points', `0,${-r} ${r},${r * 0.7} ${-r},${r * 0.7}`);
                } else if (d.type === 'TSP') {
                    const pts = d3.range(5).map(i => {
                        const angle = (Math.PI * 2 / 5) * i - Math.PI / 2;
                        return [r * Math.cos(angle), r * Math.sin(angle)];
                    }).map(p => p.join(',')).join(' ');
                    shape = g.append('polygon').attr('points', pts);
                } else {
                    shape = g.append('rect').attr('x', -r * 0.75).attr('y', -r * 0.75).attr('width', r * 1.5).attr('height', r * 1.5).attr('rx', 3);
                }

                shape.attr('fill', gradId).attr('stroke', strokeColor)
                    .attr('stroke-width', sw).attr('stroke-opacity', 0.7)
                    .attr('class', 'node-shape');

                // Specular highlight for larger Platform nodes
                if (d.type === 'Platform' && r > 12) {
                    g.append('ellipse')
                        .attr('cx', -r * 0.25).attr('cy', -r * 0.3)
                        .attr('rx', r * 0.3).attr('ry', r * 0.2)
                        .attr('fill', 'white').attr('opacity', 0.15)
                        .attr('pointer-events', 'none');
                }
            });
        }

        function initNetworkGraph() {
            if (networkGraphInitialized) return;
            if (!partnershipsData.length) return;
            networkGraphInitialized = true;

            buildGraphData();

            const container = document.getElementById('networkContainer');
            const svgEl = document.getElementById('networkSvg');
            const width = container.clientWidth;
            const height = svgEl.clientHeight;
            const isMobile = window.innerWidth <= 640;

            graphSvg = d3.select(svgEl);
            graphSvg.selectAll('*').remove();

            // === SVG Defs: gradients, glow filters, dot grid, particle glow ===
            const defs = graphSvg.append('defs');

            // Radial gradient + glow filter per node type
            Object.entries(NODE_COLORS).forEach(([type, colors]) => {
                const grad = defs.append('radialGradient')
                    .attr('id', `nodeGrad-${type}`)
                    .attr('cx', '35%').attr('cy', '35%').attr('r', '65%');
                grad.append('stop').attr('offset', '0%').attr('stop-color', colors.inner);
                grad.append('stop').attr('offset', '100%').attr('stop-color', colors.outer);

                const filter = defs.append('filter')
                    .attr('id', `nodeGlow-${type}`)
                    .attr('x', '-50%').attr('y', '-50%')
                    .attr('width', '200%').attr('height', '200%');
                filter.append('feDropShadow')
                    .attr('dx', 0).attr('dy', 0)
                    .attr('stdDeviation', 4)
                    .attr('flood-color', colors.glow)
                    .attr('flood-opacity', 0.8);
            });

            // Dot grid pattern
            defs.append('pattern')
                .attr('id', 'dotGrid')
                .attr('width', 24).attr('height', 24)
                .attr('patternUnits', 'userSpaceOnUse')
                .append('circle')
                .attr('cx', 12).attr('cy', 12).attr('r', 0.8)
                .attr('fill', 'var(--color-border-light)')
                .attr('opacity', 0.4);

            // Particle glow filter
            const particleFilter = defs.append('filter')
                .attr('id', 'particleGlow')
                .attr('x', '-100%').attr('y', '-100%')
                .attr('width', '300%').attr('height', '300%');
            particleFilter.append('feGaussianBlur')
                .attr('in', 'SourceGraphic').attr('stdDeviation', 2).attr('result', 'blur');
            const merge = particleFilter.append('feMerge');
            merge.append('feMergeNode').attr('in', 'blur');
            merge.append('feMergeNode').attr('in', 'SourceGraphic');

            // Per-edge linear gradients (source→target node color)
            const nodeById = {};
            graphNodes.forEach(n => { nodeById[n.id] = n; });
            graphEdges.forEach((edge, i) => {
                const srcId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                const tgtId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                const srcType = (nodeById[srcId] || {}).type || 'Other';
                const tgtType = (nodeById[tgtId] || {}).type || 'Other';
                const grad = defs.append('linearGradient')
                    .attr('id', `edgeGrad-${i}`)
                    .attr('gradientUnits', 'userSpaceOnUse');
                grad.append('stop').attr('offset', '0%')
                    .attr('stop-color', NODE_COLORS[srcType]?.fill || '#64748b');
                grad.append('stop').attr('offset', '100%')
                    .attr('stop-color', NODE_COLORS[tgtType]?.fill || '#64748b');
                edge._gradIdx = i;
            });

            // === Zoom ===
            graphZoom = d3.zoom()
                .scaleExtent([0.2, 4])
                .on('zoom', (event) => { graphG.attr('transform', event.transform); });
            graphSvg.call(graphZoom);

            graphG = graphSvg.append('g');

            // Background dot grid
            graphG.append('rect')
                .attr('width', 4000).attr('height', 4000)
                .attr('x', -2000).attr('y', -2000)
                .attr('fill', 'url(#dotGrid)')
                .attr('class', 'graph-bg-grid');

            // === Edges ===
            const edgeGroup = graphG.append('g').attr('class', 'edges');
            const edgeSel = edgeGroup.selectAll('line')
                .data(graphEdges)
                .join('line')
                .attr('class', d => {
                    const srcNode = nodeById[typeof d.source === 'object' ? d.source.id : d.source];
                    const tgtNode = nodeById[typeof d.target === 'object' ? d.target.id : d.target];
                    const isMinor = (srcNode && srcNode.type === 'Other' && srcNode.connections <= 1) ||
                                    (tgtNode && tgtNode.type === 'Other' && tgtNode.connections <= 1);
                    return 'edge-line' + (isMinor ? ' edge-minor' : '');
                })
                .attr('stroke', d => `url(#edgeGrad-${d._gradIdx})`)
                .attr('stroke-width', d => Math.max(1, Math.min(4, 0.8 + d.weight * 1.2)))
                .attr('stroke-opacity', d => Math.min(0.55, 0.2 + d.weight * 0.1));

            // === Nodes ===
            const nodeGroup = graphG.append('g').attr('class', 'nodes');
            const nodeSel = nodeGroup.selectAll('g')
                .data(graphNodes)
                .join('g')
                .attr('class', 'node-group');

            const shapeGroup = nodeSel.append('g').attr('class', 'node-shape-wrap');
            drawNodeShape(shapeGroup);

            // Labels — 3 tiers: hub (always visible, large), mid (3+ connections), hidden (<3)
            nodeSel.append('text')
                .attr('class', d => {
                    if (d.connections >= 8) return 'node-label label-hub';
                    if (d.connections >= 3) return 'node-label';
                    return 'node-label label-hidden';
                })
                .attr('dy', d => nodeRadius(d) + 13)
                .attr('font-size', d => {
                    if (d.connections >= 8) return '12px';
                    if (d.type === 'Other') return '9px';
                    return '10px';
                })
                .attr('font-weight', d => d.connections >= 8 ? 700 : 600)
                .text(d => d.name.length > 24 ? d.name.substring(0, 22) + '...' : d.name)
                .each(function(d) { d3.select(this).append('title').text(d.name); });

            // Minor node styling
            nodeSel.filter(d => d.type === 'Other' && d.connections <= 1)
                .classed('node-minor', true);

            // Connection count badges for nodes with 5+ connections
            nodeSel.filter(d => d.connections >= 5).append('g')
                .attr('class', 'connection-badge')
                .attr('transform', d => `translate(${nodeRadius(d) * 0.7}, ${-nodeRadius(d) * 0.7})`)
                .each(function(d) {
                    const bg = d3.select(this);
                    bg.append('circle')
                        .attr('r', 8)
                        .attr('fill', 'var(--color-primary)')
                        .attr('stroke', 'var(--color-surface)')
                        .attr('stroke-width', 2);
                    bg.append('text')
                        .attr('text-anchor', 'middle')
                        .attr('dy', '0.35em')
                        .attr('font-size', '8px')
                        .attr('font-weight', 700)
                        .attr('fill', 'white')
                        .text(d.connections);
                });

            // === Drag ===
            if (!isMobile) {
                nodeSel.call(d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) graphSimulation.alphaTarget(0.3).restart();
                        d.fx = d.x; d.fy = d.y;
                    })
                    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
                    .on('end', (event, d) => {
                        if (!event.active) graphSimulation.alphaTarget(0);
                        d.fx = null; d.fy = null;
                    }));
            }

            // === Hover/Click ===
            nodeSel.on('mouseenter', (event, d) => {
                if (selectedNode) return;
                updateGraphHighlight(d);
                showGraphTooltip(event, d);
            }).on('mouseleave', () => {
                if (selectedNode) return;
                clearGraphHighlight();
                hideGraphTooltip();
            }).on('click', (event, d) => {
                event.stopPropagation();
                if (selectedNode === d.id) {
                    selectedNode = null;
                    clearGraphHighlight();
                    closeDetailPanel();
                } else {
                    selectedNode = d.id;
                    updateGraphHighlight(d);
                    showDetailPanel(d);
                }
                hideGraphTooltip();
            });

            edgeSel.on('mouseenter', (event, d) => {
                if (selectedNode) return;
                showEdgeTooltip(event, d);
            }).on('mouseleave', () => {
                if (selectedNode) return;
                hideGraphTooltip();
            });

            graphSvg.on('click', () => {
                selectedNode = null;
                clearGraphHighlight();
                closeDetailPanel();
            });

            if (isMobile) {
                nodeSel.on('touchstart', (event, d) => {
                    event.preventDefault();
                    nodeSel.selectAll('.node-label').classed('tap-visible', false);
                    d3.select(event.currentTarget).select('.node-label').classed('tap-visible', true);
                    updateGraphHighlight(d);
                    showDetailPanel(d);
                    selectedNode = d.id;
                });
            }

            // === Force simulation ===
            graphSimulation = d3.forceSimulation(graphNodes)
                .force('link', d3.forceLink(graphEdges).id(d => d.id).distance(d => {
                    const cat = getEdgeCategory(d.partnerships[0]?.type);
                    if (cat === 'Operational') return 80;
                    if (cat === 'Data' || cat === 'Marketing') return 140;
                    return 110;
                }))
                .force('charge', d3.forceManyBody().strength(-500))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => nodeRadius(d) + 20))
                .force('x', d3.forceX(width / 2).strength(0.08))
                .force('y', d3.forceY(height / 2).strength(0.08))
                .on('tick', () => {
                    edgeSel
                        .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);

                    // Update per-edge gradient coordinates
                    graphEdges.forEach(edge => {
                        const grad = graphSvg.select(`#edgeGrad-${edge._gradIdx}`);
                        if (grad.size()) {
                            grad.attr('x1', edge.source.x).attr('y1', edge.source.y)
                                .attr('x2', edge.target.x).attr('y2', edge.target.y);
                        }
                    });

                    nodeSel.attr('transform', d => `translate(${d.x},${d.y})`);
                });

            // Apply focused view
            applyShowAllState();

            graphSimulation.alpha(1).restart();
            graphSimulation.on('end', () => { fitGraphToView(width, height); });
            setTimeout(() => fitGraphToView(width, height), 2500);
        }

        function fitGraphToView(width, height) {
            if (!graphNodes.length || !graphSvg || !graphG) return;
            const padding = 60;
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            // Only include visible nodes in the bounding box
            const visibleNodes = graphNodes.filter(d => {
                if (!showAllNodes && d.type === 'Other' && d.connections <= 1) return false;
                if (hiddenNodeTypes.has(d.type)) return false;
                return true;
            });
            if (!visibleNodes.length) return;
            visibleNodes.forEach(d => {
                const r = nodeRadius(d) + 20;
                if (d.x - r < minX) minX = d.x - r;
                if (d.y - r < minY) minY = d.y - r;
                if (d.x + r > maxX) maxX = d.x + r;
                if (d.y + r > maxY) maxY = d.y + r;
            });
            const graphWidth = maxX - minX;
            const graphHeight = maxY - minY;
            if (graphWidth <= 0 || graphHeight <= 0) return;
            const scale = Math.max(0.3, Math.min((width - padding * 2) / graphWidth, (height - padding * 2) / graphHeight, 1.2));
            const tx = (width - graphWidth * scale) / 2 - minX * scale;
            const ty = (height - graphHeight * scale) / 2 - minY * scale;
            graphSvg.transition().duration(600).call(
                graphZoom.transform,
                d3.zoomIdentity.translate(tx, ty).scale(scale)
            );
        }

        function animateEdgeParticle(d) {
            if (!graphG) return;
            const particle = graphG.append('circle')
                .attr('r', 2.5).attr('fill', 'white').attr('opacity', 0.85)
                .attr('class', 'edge-particle')
                .attr('filter', 'url(#particleGlow)');
            let count = 0;
            function pulse() {
                if (count >= 5 || !graphG.selectAll('.edge-particle').size()) { particle.remove(); return; }
                count++;
                particle
                    .attr('cx', d.source.x).attr('cy', d.source.y)
                    .transition().duration(1200).ease(d3.easeLinear)
                    .attr('cx', d.target.x).attr('cy', d.target.y)
                    .on('end', pulse);
            }
            pulse();
        }

        function updateGraphHighlight(d) {
            const connectedIds = new Set();
            connectedIds.add(d.id);
            graphEdges.forEach(e => {
                const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                if (srcId === d.id) connectedIds.add(tgtId);
                if (tgtId === d.id) connectedIds.add(srcId);
            });

            // Apply glow filter per node type on highlighted nodes
            graphG.selectAll('.node-group')
                .classed('highlighted', n => connectedIds.has(n.id))
                .classed('dimmed', n => !connectedIds.has(n.id))
                .each(function(n) {
                    const shapeEl = d3.select(this).select('.node-shape');
                    if (connectedIds.has(n.id)) {
                        shapeEl.attr('filter', `url(#nodeGlow-${n.type})`);
                    } else {
                        shapeEl.attr('filter', null);
                    }
                });

            graphG.selectAll('.edge-line')
                .classed('highlighted', e => {
                    const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                    const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                    return srcId === d.id || tgtId === d.id;
                })
                .classed('dimmed', e => {
                    const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                    const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                    return srcId !== d.id && tgtId !== d.id;
                });

            // Animate particles on highlighted edges (max 6, skip on mobile)
            graphG.selectAll('.edge-particle').remove();
            if (window.innerWidth > 640) {
                let particleCount = 0;
                graphG.selectAll('.edge-line.highlighted').each(function(ed) {
                    if (particleCount < 6) {
                        animateEdgeParticle(ed);
                        particleCount++;
                    }
                });
            }
        }

        function clearGraphHighlight() {
            graphG.selectAll('.node-group').classed('highlighted', false).classed('dimmed', false);
            graphG.selectAll('.node-group').each(function() {
                d3.select(this).select('.node-shape').attr('filter', null);
            });
            graphG.selectAll('.edge-line').classed('highlighted', false).classed('dimmed', false);
            graphG.selectAll('.edge-particle').remove();
        }

        function showGraphTooltip(event, d) {
            const tooltip = document.getElementById('graphTooltip');
            const container = document.getElementById('networkContainer');
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left + 14;
            const y = event.clientY - rect.top - 12;
            const colors = NODE_COLORS[d.type] || NODE_COLORS.Other;

            tooltip.innerHTML = `
                <div class="tt-name">
                    <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${colors.fill};box-shadow:0 0 6px ${colors.fill}40;flex-shrink:0;"></span>
                    ${d.name}
                </div>
                <div class="tt-role" style="background:${colors.fill}18;color:${colors.fill};">${d.rolesStr}</div>
                <div class="tt-count">
                    <span class="material-icons-outlined" style="font-size:14px;">link</span>
                    ${d.partnerships.length} partnership${d.partnerships.length !== 1 ? 's' : ''} &middot; ${d.connections} connection${d.connections !== 1 ? 's' : ''}
                </div>
            `;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.classList.add('visible');
        }

        function showEdgeTooltip(event, d) {
            const tooltip = document.getElementById('graphTooltip');
            const container = document.getElementById('networkContainer');
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left + 12;
            const y = event.clientY - rect.top - 10;

            const srcName = typeof d.source === 'object' ? d.source.name : d.source;
            const tgtName = typeof d.target === 'object' ? d.target.name : d.target;

            tooltip.innerHTML = `
                <div class="tt-name">${srcName} &harr; ${tgtName}</div>
                ${d.partnerships.map(p => `<div class="tt-count" style="margin-top:2px">${p.name} <span style="opacity:0.6">(${p.type})</span></div>`).join('')}
            `;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.classList.add('visible');
        }

        function hideGraphTooltip() {
            document.getElementById('graphTooltip').classList.remove('visible');
        }

        function showDetailPanel(d) {
            const panel = document.getElementById('graphDetailPanel');
            const content = document.getElementById('graphDetailContent');
            const colors = NODE_COLORS[d.type] || NODE_COLORS.Other;

            const seen = new Set();
            const unique = d.partnerships.filter(p => {
                if (seen.has(p.name)) return false;
                seen.add(p.name);
                return true;
            });

            content.innerHTML = `
                <div style="background:linear-gradient(135deg, ${colors.fill}15, ${colors.fill}05);padding:1.5rem 1.5rem 1.25rem;border-bottom:1px solid var(--color-border-light);">
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.375rem;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${colors.fill};box-shadow:0 0 8px ${colors.fill}50;"></span>
                        <div class="dp-name" style="padding-right:2rem;">${d.name}</div>
                    </div>
                    <div class="dp-role" style="color:${colors.fill};">${d.rolesStr}</div>
                    <div style="font-size:0.8rem;color:var(--color-text-secondary);margin-top:0.25rem;">
                        <span class="material-icons-outlined" style="font-size:14px;vertical-align:-2px;">link</span>
                        ${d.connections} connection${d.connections !== 1 ? 's' : ''}
                    </div>
                </div>
                <div style="padding:1.25rem 1.5rem;">
                    <div style="font-weight:600;font-size:0.75rem;color:var(--color-text-tertiary);margin-bottom:0.625rem;text-transform:uppercase;letter-spacing:0.06em;">
                        Partnerships (${unique.length})
                    </div>
                    ${unique.map(p => {
                        const edgeColor = getEdgeColor(p.type);
                        return `
                            <div class="dp-partnership" style="border-left-color:${edgeColor};">
                                <div class="dp-p-name">${p.name}</div>
                                <div class="dp-p-type">${p.type}</div>
                                ${p.details ? `<div style="margin-top:4px;font-size:0.7rem;color:var(--color-text-tertiary);line-height:1.5;">${p.details}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            panel.classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('graphDetailPanel').classList.remove('open');
        }

        function filterGraph() {
            if (!networkGraphInitialized) return;
            const filterVal = document.getElementById('graphTypeFilter').value;

            function isNodeHidden(node) {
                if (!node) return false;
                if (!showAllNodes && node.type === 'Other' && node.connections <= 1) return true;
                if (hiddenNodeTypes.has(node.type)) return true;
                return false;
            }

            graphG.selectAll('.edge-line').each(function(d) {
                const matchesFilter = !filterVal || d.partnerships.some(p => p.type === filterVal);
                const srcNode = graphNodes.find(n => n.id === (typeof d.source === 'object' ? d.source.id : d.source));
                const tgtNode = graphNodes.find(n => n.id === (typeof d.target === 'object' ? d.target.id : d.target));
                const hidden = !matchesFilter || isNodeHidden(srcNode) || isNodeHidden(tgtNode);
                d3.select(this).style('display', hidden ? 'none' : null);
            });

            // Show/hide nodes: respect type filter, showAll state, and legend filters
            if (filterVal) {
                const visibleNodeIds = new Set();
                graphEdges.forEach(e => {
                    if (e.partnerships.some(p => p.type === filterVal)) {
                        const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                        const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                        visibleNodeIds.add(srcId);
                        visibleNodeIds.add(tgtId);
                    }
                });
                graphG.selectAll('.node-group').each(function(d) {
                    const matchesFilter = visibleNodeIds.has(d.id);
                    const hidden = !matchesFilter || isNodeHidden(d);
                    d3.select(this).style('display', hidden ? 'none' : null);
                });
            } else {
                // No filter — just apply showAll and legend state
                graphG.selectAll('.node-group').each(function(d) {
                    d3.select(this).style('display', isNodeHidden(d) ? 'none' : null);
                });
            }
        }

        function searchGraph() {
            if (!networkGraphInitialized) return;
            const query = (document.getElementById('graphSearchInput').value || '').toLowerCase().trim();

            if (!query) {
                clearGraphHighlight();
                graphG.selectAll('.node-group').classed('search-match', false);
                return;
            }

            const matches = graphNodes.filter(n => n.name.toLowerCase().includes(query));
            if (matches.length === 1) {
                updateGraphHighlight(matches[0]);
            } else if (matches.length > 1) {
                clearGraphHighlight();
                const matchIds = new Set(matches.map(m => m.id));
                graphG.selectAll('.node-group')
                    .classed('highlighted', n => matchIds.has(n.id))
                    .classed('dimmed', n => !matchIds.has(n.id));
                graphG.selectAll('.edge-line').classed('dimmed', true);
            } else {
                clearGraphHighlight();
                graphG.selectAll('.node-group').classed('dimmed', true);
                graphG.selectAll('.edge-line').classed('dimmed', true);
            }
        }

        function applyShowAllState() {
            if (!networkGraphInitialized || !graphG) return;
            // Hide/show nodes respecting both showAll toggle and legend filters
            graphG.selectAll('.node-group').each(function(d) {
                const isPeripheral = d.type === 'Other' && d.connections <= 1;
                const hidden = (!showAllNodes && isPeripheral) || hiddenNodeTypes.has(d.type);
                d3.select(this).style('display', hidden ? 'none' : null);
            });
            graphG.selectAll('.edge-line').each(function(d) {
                const srcNode = graphNodes.find(n => n.id === (typeof d.source === 'object' ? d.source.id : d.source));
                const tgtNode = graphNodes.find(n => n.id === (typeof d.target === 'object' ? d.target.id : d.target));
                const srcHidden = (!showAllNodes && srcNode && srcNode.type === 'Other' && srcNode.connections <= 1) || (srcNode && hiddenNodeTypes.has(srcNode.type));
                const tgtHidden = (!showAllNodes && tgtNode && tgtNode.type === 'Other' && tgtNode.connections <= 1) || (tgtNode && hiddenNodeTypes.has(tgtNode.type));
                d3.select(this).style('display', (srcHidden || tgtHidden) ? 'none' : null);
            });
            // Update button label
            const label = document.getElementById('toggleAllLabel');
            if (label) label.textContent = showAllNodes ? 'Focused' : 'Show All';
            const icon = document.querySelector('#graphToggleAll .material-icons-outlined');
            if (icon) icon.textContent = showAllNodes ? 'visibility_off' : 'visibility';
        }

        function toggleShowAll() {
            showAllNodes = !showAllNodes;
            applyShowAllState();
            // Re-run filter if active
            const filterVal = document.getElementById('graphTypeFilter').value;
            if (filterVal) filterGraph();
        }

        function resetGraphView() {
            if (!graphSvg || !graphZoom) return;
            graphSvg.transition().duration(500).call(graphZoom.transform, d3.zoomIdentity);
            document.getElementById('graphTypeFilter').value = '';
            document.getElementById('graphSearchInput').value = '';
            showAllNodes = true;
            hiddenNodeTypes.clear();
            document.querySelectorAll('#networkLegend .legend-item[data-node-type]').forEach(el => el.classList.remove('legend-inactive'));
            applyShowAllState();
            filterGraph();
            clearGraphHighlight();
            clearGuidedQuestion();
            if (graphG) graphG.selectAll('.edge-particle').remove();
            closeDetailPanel();
            selectedNode = null;
        }

        // Legend filter toggle
        function toggleLegendFilter(el) {
            const type = el.dataset.nodeType;
            if (!type || !graphG) return;
            if (hiddenNodeTypes.has(type)) {
                hiddenNodeTypes.delete(type);
                el.classList.remove('legend-inactive');
            } else {
                hiddenNodeTypes.add(type);
                el.classList.add('legend-inactive');
            }
            applyShowAllState();
            const filterVal = document.getElementById('graphTypeFilter').value;
            if (filterVal) filterGraph();
        }

        // Zoom controls
        function graphZoomIn() {
            if (!graphSvg || !graphZoom) return;
            graphSvg.transition().duration(300).call(graphZoom.scaleBy, 1.3);
        }
        function graphZoomOut() {
            if (!graphSvg || !graphZoom) return;
            graphSvg.transition().duration(300).call(graphZoom.scaleBy, 0.7);
        }
        function graphFitToView() {
            if (!graphSvg || !graphG) return;
            const container = document.getElementById('networkContainer');
            if (!container) return;
            const rect = container.getBoundingClientRect();
            fitGraphToView(rect.width, rect.height);
        }

        function updateGraphColors() {
            if (!networkGraphInitialized || !graphG) return;
            // Re-draw node shapes (uses gradients which are color-independent)
            graphG.selectAll('.node-shape-wrap').each(function(d) {
                drawNodeShape(d3.select(this));
            });
            // Update dot grid pattern fill (uses CSS variable)
            graphSvg.select('#dotGrid circle')
                .attr('fill', 'var(--color-border-light)');
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            var hash = location.hash.replace('#','');
            var valid = ['terminology','tracker','network','simulation','about','contact'];
            switchView(valid.indexOf(hash) !== -1 ? hash : 'terminology');
        });
    </script>
</body>
</html>
